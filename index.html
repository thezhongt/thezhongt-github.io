<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <title>7d567758b4294a5881a88a47d7288236</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      overflow-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
      h1 {
        font-size: 1.8em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
      overflow-wrap: normal;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC ul {
      padding-left: 1.3em;
    }
    #TOC > ul {
      padding-left: 0;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    div.columns{display: flex; gap: min(4vw, 1.5em);}
    div.column{flex: auto; overflow-x: auto;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    ul.task-list li input[type="checkbox"] {
      width: 0.8em;
      margin: 0 0.8em 0.2em -1.6em;
      vertical-align: middle;
    }
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    .sourceCode { overflow: visible; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { color: #008000; } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { color: #008000; font-weight: bold; } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<section id="predicting-short-term-stock-price-movements"
class="cell markdown">
<h1><center>Predicting Short Term Stock Price Movements</center></h1>
<p>Spring 2025 Data Science Project</p>
<p>Authors and Contributions:</p>
<ul>
<li><p>Arman Dashtipour: Project Idea …</p></li>
<li><p>Gregory Seleznev: Project Idea, Dataset Curation &amp;
Preprocessing (Combining data sources, feature extraction &amp;
creation), Data Exploration (Pre-Tax Profit VS ROA &amp; Ratio Changes
vs Stock Price Changes), Stock return smoothing, ML Design (Simple
approach version).</p></li>
<li><p>Shankar Soma: Project Idea, Exploratory Data Analysis (basic data
overview, number of features &amp; entries, missing values, feature
over-representation, feature count visualizations, correlation matrix,
outlier detection, monthly volume trends), ML LSTM model with attention
developed for short term change predictions.</p></li>
<li><p>Shashank Thirumale: Project Idea. Data Exploration (Which
industry has grown the most and Relationship between Debt to Equity
Ratio and Return on Equity) performed Hypothesis test for these
observations. Performed hypothesis test to show model performance in
relation to randomly guessing, and wrote insights and conclusions that
can be made about the model’s performance.</p></li>
<li><p>Thomas Zhong: Project Idea, Introduction, Dataset Curation &amp;
Preprocessing, Data Exploration and Summary Statistics (Risk Adjusted
Metrics across industries, including Sharpe, Rolling Sharpe, and Max
Drawdown vs Average Return), Hypothesis Testing, Final Tutorial Report
Creation.</p></li>
</ul>
</section>
<section id="introduction" class="cell markdown">
<h1>Introduction</h1>
<h3 id="why-is-money-important">Why is money important?</h3>
<p>Wealth is much more than a number in a bank account, it represents
quality of life, social status, and being in control of your life.
People work all their lives in the pursuit of having more money and
being wealthier.</p>
<h3 id="why-stocks">Why stocks?</h3>
<p>The stock market is one of the largest and most lucrative markets in
the world. If someone could consistently and accurately predict price
movements and capitalize off it, it would be possible to near infinitely
multiply their money. Unfortunately, it's not as simple as that. The
stock market is constantly growing and evolving to be more and more
efficient, while firms spend billions trying to gain the slightest edge
over the market.</p>
<h3 id="our-work">Our Work</h3>
<p>In this project, we aim to gain some predictive power over short term
price movements in the stock market. It's impossible to consistently win
every trade, but any edge over the market can be extremely powerful. If
we can predict whether a stock will go up or down with greater than 50%
acuracy, even by a small margin, we can leverage this statistical edge
and open up the potential to generate positive returns. Our goal is to
create an advantage for us that can lead to meaningful results in the
market.</p>
</section>
<div class="cell markdown">
<p>Let's begin by installing the required packages and importing the
necessary libraries!</p>
</div>
<div class="cell code" data-execution_count="2">
<div class="sourceCode" id="cb1"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Uncomment the below line if you need to install the packages</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co"># %pip install pandas matplotlib numpy yfinance scipy pandas-ta</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> yfinance <span class="im">as</span> yf</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> scipy.stats <span class="im">as</span> stats</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>warnings.simplefilter(action<span class="op">=</span><span class="st">&#39;ignore&#39;</span>, category<span class="op">=</span><span class="pp">FutureWarning</span>)</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">&#39;display.max_columns&#39;</span>, <span class="va">None</span>)</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co"># pd.set_option(&#39;display.max_rows&#39;, 2000)</span></span></code></pre></div>
</div>
<section id="data-curation" class="cell markdown">
<h1>Data Curation</h1>
<p>The datasets used in this project are as follows:</p>
<ul>
<li>iShares Core S&amp;P ETF (<a
href="https://www.ishares.com/us/products/239726/ishares-core-sp-500-etf"
class="uri">https://www.ishares.com/us/products/239726/ishares-core-sp-500-etf</a>)</li>
</ul>
<p>An official list of all companies in the S&amp;P500 index, including
their name, ticker, and sector.</p>
<ul>
<li>Stock Data and Ratios from HuggingFace (<a
href="https://huggingface.co/datasets/pmoe7/SP_500_Stocks_Data-ratios_news_price_10_yrs"
class="uri">https://huggingface.co/datasets/pmoe7/SP_500_Stocks_Data-ratios_news_price_10_yrs</a>)</li>
</ul>
<p>Historical financial data for S&amp;P500 companies over the past 10
years, including prices and financial ratios.</p>
</section>
<div class="cell markdown">
<p>These two lines load CSV files of the datasets into pandas
DataFrames:</p>
</div>
<div class="cell code" data-execution_count="3">
<div class="sourceCode" id="cb2"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># get the dataframes</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>ratio_df <span class="op">=</span> pd.read_csv(<span class="st">&quot;sp500_daily_ratios_20yrs.csv&quot;</span>)</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>sp500_info_df <span class="op">=</span> pd.read_csv(<span class="st">&quot;sp500_info.csv&quot;</span>)</span></code></pre></div>
</div>
<section id="data-preprocessing" class="cell markdown">
<h3>Data Preprocessing</h3>
<p>We start by converting the Date column to proper datetime format.
Then, we match tickers between the two datasets so we can add Sector and
Industry information from sp500_info_df to our main ratio_df. After
inserting the new columns, we loop through the common tickers and fill
in the corresponding sector values. Finally, we keep only the rows with
known sectors to ensure cleaner analysis.</p>
</section>
<div class="cell code" data-execution_count="4">
<div class="sourceCode" id="cb3"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># convert date column to datetime</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>ratio_df[<span class="st">&quot;Date&quot;</span>] <span class="op">=</span> pd.to_datetime(ratio_df[<span class="st">&quot;Date&quot;</span>])</span></code></pre></div>
</div>
<section
id="preprocessing-find-common-tickers-between-sp500_info-and-sp500_daily_ratios"
class="cell markdown">
<h3>Preprocessing: Find Common Tickers Between sp500_info and
sp500_daily_ratios</h3>
</section>
<div class="cell code" data-execution_count="5">
<div class="sourceCode" id="cb4"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># convert date column to datetime</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>ratio_df[<span class="st">&quot;Date&quot;</span>] <span class="op">=</span> pd.to_datetime(ratio_df[<span class="st">&quot;Date&quot;</span>])</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co"># add sector to dataframe</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co"># the ratios df has missing tickers so we need to find the ones that are common between sp500_info and sp500_daily_ratios</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>tickers1 <span class="op">=</span> ratio_df[<span class="st">&quot;Ticker&quot;</span>].unique()</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>tickers2 <span class="op">=</span> sp500_info_df[<span class="st">&quot;Symbol&quot;</span>].unique()</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>tickers_in_both_dfs <span class="op">=</span> np.intersect1d(tickers1, tickers2)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;There are </span><span class="sc">{</span><span class="bu">len</span>(tickers_in_both_dfs)<span class="sc">}</span><span class="ss"> tickers that we can analyze with known Sector value&quot;</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="co"># we want to add two new features: sector and industry</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>ratio_df.insert(<span class="dv">1</span>, <span class="st">&quot;Sector&quot;</span>, <span class="va">None</span>)</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>ratio_df.insert(<span class="dv">2</span>, <span class="st">&quot;Industry&quot;</span>, <span class="va">None</span>)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ticker <span class="kw">in</span> tickers_in_both_dfs:</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    sector <span class="op">=</span> sp500_info_df[sp500_info_df[<span class="st">&quot;Symbol&quot;</span>] <span class="op">==</span> ticker][<span class="st">&quot;Sector&quot;</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    ratio_df.loc[ratio_df[<span class="st">&quot;Ticker&quot;</span>] <span class="op">==</span> ticker, <span class="st">&quot;Sector&quot;</span>] <span class="op">=</span> sector</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Only keep rows with known sector. this removes ~40 tickers, might need to remove this later</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>ratio_df <span class="op">=</span> ratio_df.dropna(subset<span class="op">=</span>[<span class="st">&quot;Sector&quot;</span>])</span></code></pre></div>
<div class="output stream stdout">
<pre><code>There are 280 tickers that we can analyze with known Sector value
</code></pre>
</div>
</div>
<div class="cell markdown">
<p>We create this map_sector_to_industry function to group detailed
industry categories into broader, more manageable industry sectors. This
helps simplify our analysis by reducing dozens of specific industry
labels (like "Semiconductors" or "Health Care Equipment") into
higher-level groups (like "Technology &amp; Software" or "Health Care
&amp; Life Sciences"), making trends and comparisons easier to
interpret.</p>
</div>
<div class="cell code" data-execution_count="6">
<div class="sourceCode" id="cb6"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> map_sector_to_industry(sector):</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>    industry_map <span class="op">=</span> {</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Technology &amp; Software</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Application Software&quot;</span>: <span class="st">&quot;Technology &amp; Software&quot;</span>,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Systems Software&quot;</span>: <span class="st">&quot;Technology &amp; Software&quot;</span>,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Internet Services &amp; Infrastructure&quot;</span>: <span class="st">&quot;Technology &amp; Software&quot;</span>,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Interactive Media &amp; Services&quot;</span>: <span class="st">&quot;Technology &amp; Software&quot;</span>,</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Interactive Home Entertainment&quot;</span>: <span class="st">&quot;Technology &amp; Software&quot;</span>,</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Communications Equipment&quot;</span>: <span class="st">&quot;Technology &amp; Software&quot;</span>,</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Technology Hardware, Storage &amp; Peripherals&quot;</span>: <span class="st">&quot;Technology &amp; Software&quot;</span>,</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Technology Distributors&quot;</span>: <span class="st">&quot;Technology &amp; Software&quot;</span>,</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;IT Consulting &amp; Other Services&quot;</span>: <span class="st">&quot;Technology &amp; Software&quot;</span>,</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Data Processing &amp; Outsourced Services&quot;</span>: <span class="st">&quot;Technology &amp; Software&quot;</span>,</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Financial Exchanges &amp; Data&quot;</span>: <span class="st">&quot;Technology &amp; Software&quot;</span>,</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Semiconductor Materials &amp; Equipment&quot;</span>: <span class="st">&quot;Technology &amp; Software&quot;</span>,</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Semiconductors&quot;</span>: <span class="st">&quot;Technology &amp; Software&quot;</span>,</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Electronic Components&quot;</span>: <span class="st">&quot;Technology &amp; Software&quot;</span>,</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Electronic Equipment &amp; Instruments&quot;</span>: <span class="st">&quot;Technology &amp; Software&quot;</span>,</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Health Care &amp; Life Sciences</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Biotechnology&quot;</span>: <span class="st">&quot;Health Care &amp; Life Sciences&quot;</span>,</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Health Care Equipment&quot;</span>: <span class="st">&quot;Health Care &amp; Life Sciences&quot;</span>,</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Health Care Services&quot;</span>: <span class="st">&quot;Health Care &amp; Life Sciences&quot;</span>,</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Health Care Distributors&quot;</span>: <span class="st">&quot;Health Care &amp; Life Sciences&quot;</span>,</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Managed Health Care&quot;</span>: <span class="st">&quot;Health Care &amp; Life Sciences&quot;</span>,</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Pharmaceuticals&quot;</span>: <span class="st">&quot;Health Care &amp; Life Sciences&quot;</span>,</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Health Care Supplies&quot;</span>: <span class="st">&quot;Health Care &amp; Life Sciences&quot;</span>,</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Life Sciences Tools &amp; Services&quot;</span>: <span class="st">&quot;Health Care &amp; Life Sciences&quot;</span>,</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Health Care Facilities&quot;</span>: <span class="st">&quot;Health Care &amp; Life Sciences&quot;</span>,</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Financial Services</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Diversified Banks&quot;</span>: <span class="st">&quot;Financial Services&quot;</span>,</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Regional Banks&quot;</span>: <span class="st">&quot;Financial Services&quot;</span>,</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Asset Management &amp; Custody Banks&quot;</span>: <span class="st">&quot;Financial Services&quot;</span>,</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Investment Banking &amp; Brokerage&quot;</span>: <span class="st">&quot;Financial Services&quot;</span>,</span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Insurance Brokers&quot;</span>: <span class="st">&quot;Financial Services&quot;</span>,</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Life &amp; Health Insurance&quot;</span>: <span class="st">&quot;Financial Services&quot;</span>,</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Multi-line Insurance&quot;</span>: <span class="st">&quot;Financial Services&quot;</span>,</span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Property &amp; Casualty Insurance&quot;</span>: <span class="st">&quot;Financial Services&quot;</span>,</span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Consumer Finance&quot;</span>: <span class="st">&quot;Financial Services&quot;</span>,</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Energy &amp; Utilities</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Electric Utilities&quot;</span>: <span class="st">&quot;Energy &amp; Utilities&quot;</span>,</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Multi-Utilities&quot;</span>: <span class="st">&quot;Energy &amp; Utilities&quot;</span>,</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Gas Utilities&quot;</span>: <span class="st">&quot;Energy &amp; Utilities&quot;</span>,</span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Water Utilities&quot;</span>: <span class="st">&quot;Energy &amp; Utilities&quot;</span>,</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Independent Power Producers &amp; Energy Traders&quot;</span>: <span class="st">&quot;Energy &amp; Utilities&quot;</span>,</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Integrated Oil &amp; Gas&quot;</span>: <span class="st">&quot;Energy &amp; Utilities&quot;</span>,</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Oil &amp; Gas Equipment &amp; Services&quot;</span>: <span class="st">&quot;Energy &amp; Utilities&quot;</span>,</span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Oil &amp; Gas Exploration &amp; Production&quot;</span>: <span class="st">&quot;Energy &amp; Utilities&quot;</span>,</span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Oil &amp; Gas Refining &amp; Marketing&quot;</span>: <span class="st">&quot;Energy &amp; Utilities&quot;</span>,</span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Oil &amp; Gas Storage &amp; Transportation&quot;</span>: <span class="st">&quot;Energy &amp; Utilities&quot;</span>,</span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Consumer Goods</span></span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Household Products&quot;</span>: <span class="st">&quot;Consumer Goods&quot;</span>,</span>
<span id="cb6-56"><a href="#cb6-56" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Personal Care Products&quot;</span>: <span class="st">&quot;Consumer Goods&quot;</span>,</span>
<span id="cb6-57"><a href="#cb6-57" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Tobacco&quot;</span>: <span class="st">&quot;Consumer Goods&quot;</span>,</span>
<span id="cb6-58"><a href="#cb6-58" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Packaged Foods &amp; Meats&quot;</span>: <span class="st">&quot;Consumer Goods&quot;</span>,</span>
<span id="cb6-59"><a href="#cb6-59" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Soft Drinks &amp; Non-alcoholic Beverages&quot;</span>: <span class="st">&quot;Consumer Goods&quot;</span>,</span>
<span id="cb6-60"><a href="#cb6-60" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Consumer Electronics&quot;</span>: <span class="st">&quot;Consumer Goods&quot;</span>,</span>
<span id="cb6-61"><a href="#cb6-61" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Home Furnishings&quot;</span>: <span class="st">&quot;Consumer Goods&quot;</span>,</span>
<span id="cb6-62"><a href="#cb6-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-63"><a href="#cb6-63" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Retail</span></span>
<span id="cb6-64"><a href="#cb6-64" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Broadline Retail&quot;</span>: <span class="st">&quot;Retail&quot;</span>,</span>
<span id="cb6-65"><a href="#cb6-65" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Automotive Retail&quot;</span>: <span class="st">&quot;Retail&quot;</span>,</span>
<span id="cb6-66"><a href="#cb6-66" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Consumer Staples Merchandise Retail&quot;</span>: <span class="st">&quot;Retail&quot;</span>,</span>
<span id="cb6-67"><a href="#cb6-67" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Computer &amp; Electronics Retail&quot;</span>: <span class="st">&quot;Retail&quot;</span>,</span>
<span id="cb6-68"><a href="#cb6-68" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Food Retail&quot;</span>: <span class="st">&quot;Retail&quot;</span>,</span>
<span id="cb6-69"><a href="#cb6-69" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Home Improvement Retail&quot;</span>: <span class="st">&quot;Retail&quot;</span>,</span>
<span id="cb6-70"><a href="#cb6-70" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Restaurants&quot;</span>: <span class="st">&quot;Retail&quot;</span>,</span>
<span id="cb6-71"><a href="#cb6-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-72"><a href="#cb6-72" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Real Estate (REITs)</span></span>
<span id="cb6-73"><a href="#cb6-73" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Hotel &amp; Resort REITs&quot;</span>: <span class="st">&quot;Real Estate (REITs)&quot;</span>,</span>
<span id="cb6-74"><a href="#cb6-74" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Multi-Family Residential REITs&quot;</span>: <span class="st">&quot;Real Estate (REITs)&quot;</span>,</span>
<span id="cb6-75"><a href="#cb6-75" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Office REITs&quot;</span>: <span class="st">&quot;Real Estate (REITs)&quot;</span>,</span>
<span id="cb6-76"><a href="#cb6-76" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Retail REITs&quot;</span>: <span class="st">&quot;Real Estate (REITs)&quot;</span>,</span>
<span id="cb6-77"><a href="#cb6-77" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Self-Storage REITs&quot;</span>: <span class="st">&quot;Real Estate (REITs)&quot;</span>,</span>
<span id="cb6-78"><a href="#cb6-78" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Data Center REITs&quot;</span>: <span class="st">&quot;Real Estate (REITs)&quot;</span>,</span>
<span id="cb6-79"><a href="#cb6-79" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Telecom Tower REITs&quot;</span>: <span class="st">&quot;Real Estate (REITs)&quot;</span>,</span>
<span id="cb6-80"><a href="#cb6-80" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Other Specialized REITs&quot;</span>: <span class="st">&quot;Real Estate (REITs)&quot;</span>,</span>
<span id="cb6-81"><a href="#cb6-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-82"><a href="#cb6-82" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Industrials &amp; Manufacturing</span></span>
<span id="cb6-83"><a href="#cb6-83" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Aerospace &amp; Defense&quot;</span>: <span class="st">&quot;Industrials &amp; Manufacturing&quot;</span>,</span>
<span id="cb6-84"><a href="#cb6-84" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Industrial Conglomerates&quot;</span>: <span class="st">&quot;Industrials &amp; Manufacturing&quot;</span>,</span>
<span id="cb6-85"><a href="#cb6-85" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Industrial Gases&quot;</span>: <span class="st">&quot;Industrials &amp; Manufacturing&quot;</span>,</span>
<span id="cb6-86"><a href="#cb6-86" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Industrial Machinery &amp; Supplies &amp; Components&quot;</span>: <span class="st">&quot;Industrials &amp; Manufacturing&quot;</span>,</span>
<span id="cb6-87"><a href="#cb6-87" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Electrical Components &amp; Equipment&quot;</span>: <span class="st">&quot;Industrials &amp; Manufacturing&quot;</span>,</span>
<span id="cb6-88"><a href="#cb6-88" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Construction Machinery &amp; Heavy Transportation Equipment&quot;</span>: <span class="st">&quot;Industrials &amp; Manufacturing&quot;</span>,</span>
<span id="cb6-89"><a href="#cb6-89" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Building Products&quot;</span>: <span class="st">&quot;Industrials &amp; Manufacturing&quot;</span>,</span>
<span id="cb6-90"><a href="#cb6-90" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Construction Materials&quot;</span>: <span class="st">&quot;Industrials &amp; Manufacturing&quot;</span>,</span>
<span id="cb6-91"><a href="#cb6-91" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Fertilizers &amp; Agricultural Chemicals&quot;</span>: <span class="st">&quot;Industrials &amp; Manufacturing&quot;</span>,</span>
<span id="cb6-92"><a href="#cb6-92" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Specialty Chemicals&quot;</span>: <span class="st">&quot;Industrials &amp; Manufacturing&quot;</span>,</span>
<span id="cb6-93"><a href="#cb6-93" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Paper &amp; Plastic Packaging Products &amp; Materials&quot;</span>: <span class="st">&quot;Industrials &amp; Manufacturing&quot;</span>,</span>
<span id="cb6-94"><a href="#cb6-94" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Trading Companies &amp; Distributors&quot;</span>: <span class="st">&quot;Industrials &amp; Manufacturing&quot;</span>,</span>
<span id="cb6-95"><a href="#cb6-95" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Distributors&quot;</span>: <span class="st">&quot;Industrials &amp; Manufacturing&quot;</span>,</span>
<span id="cb6-96"><a href="#cb6-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-97"><a href="#cb6-97" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Transportation &amp; Logistics</span></span>
<span id="cb6-98"><a href="#cb6-98" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Air Freight &amp; Logistics&quot;</span>: <span class="st">&quot;Transportation &amp; Logistics&quot;</span>,</span>
<span id="cb6-99"><a href="#cb6-99" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Cargo Ground Transportation&quot;</span>: <span class="st">&quot;Transportation &amp; Logistics&quot;</span>,</span>
<span id="cb6-100"><a href="#cb6-100" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Rail Transportation&quot;</span>: <span class="st">&quot;Transportation &amp; Logistics&quot;</span>,</span>
<span id="cb6-101"><a href="#cb6-101" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Passenger Airlines&quot;</span>: <span class="st">&quot;Transportation &amp; Logistics&quot;</span>,</span>
<span id="cb6-102"><a href="#cb6-102" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-103"><a href="#cb6-103" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Automotive</span></span>
<span id="cb6-104"><a href="#cb6-104" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Automobile Manufacturers&quot;</span>: <span class="st">&quot;Automotive&quot;</span>,</span>
<span id="cb6-105"><a href="#cb6-105" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Automotive Parts &amp; Equipment&quot;</span>: <span class="st">&quot;Automotive&quot;</span>,</span>
<span id="cb6-106"><a href="#cb6-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-107"><a href="#cb6-107" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Media, Entertainment &amp; Leisure</span></span>
<span id="cb6-108"><a href="#cb6-108" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Movies &amp; Entertainment&quot;</span>: <span class="st">&quot;Media, Entertainment &amp; Leisure&quot;</span>,</span>
<span id="cb6-109"><a href="#cb6-109" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Casinos &amp; Gaming&quot;</span>: <span class="st">&quot;Media, Entertainment &amp; Leisure&quot;</span>,</span>
<span id="cb6-110"><a href="#cb6-110" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Hotels, Resorts &amp; Cruise Lines&quot;</span>: <span class="st">&quot;Media, Entertainment &amp; Leisure&quot;</span>,</span>
<span id="cb6-111"><a href="#cb6-111" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Leisure Products&quot;</span>: <span class="st">&quot;Media, Entertainment &amp; Leisure&quot;</span>,</span>
<span id="cb6-112"><a href="#cb6-112" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Advertising&quot;</span>: <span class="st">&quot;Media, Entertainment &amp; Leisure&quot;</span>,</span>
<span id="cb6-113"><a href="#cb6-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-114"><a href="#cb6-114" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Telecommunications</span></span>
<span id="cb6-115"><a href="#cb6-115" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Cable &amp; Satellite&quot;</span>: <span class="st">&quot;Telecommunications&quot;</span>,</span>
<span id="cb6-116"><a href="#cb6-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-117"><a href="#cb6-117" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Agriculture</span></span>
<span id="cb6-118"><a href="#cb6-118" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Agricultural Products &amp; Services&quot;</span>: <span class="st">&quot;Agriculture&quot;</span>,</span>
<span id="cb6-119"><a href="#cb6-119" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Agricultural &amp; Farm Machinery&quot;</span>: <span class="st">&quot;Agriculture&quot;</span>,</span>
<span id="cb6-120"><a href="#cb6-120" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-121"><a href="#cb6-121" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Real Estate Services &amp; Consulting</span></span>
<span id="cb6-122"><a href="#cb6-122" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Real Estate Services&quot;</span>: <span class="st">&quot;Real Estate Services &amp; Consulting&quot;</span>,</span>
<span id="cb6-123"><a href="#cb6-123" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Research &amp; Consulting Services&quot;</span>: <span class="st">&quot;Real Estate Services &amp; Consulting&quot;</span>,</span>
<span id="cb6-124"><a href="#cb6-124" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Human Resource &amp; Employment Services&quot;</span>: <span class="st">&quot;Real Estate Services &amp; Consulting&quot;</span>,</span>
<span id="cb6-125"><a href="#cb6-125" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Diversified Support Services&quot;</span>: <span class="st">&quot;Real Estate Services &amp; Consulting&quot;</span>,</span>
<span id="cb6-126"><a href="#cb6-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-127"><a href="#cb6-127" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Materials &amp; Natural Resources</span></span>
<span id="cb6-128"><a href="#cb6-128" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Gold&quot;</span>: <span class="st">&quot;Materials &amp; Natural Resources&quot;</span>,</span>
<span id="cb6-129"><a href="#cb6-129" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Copper&quot;</span>: <span class="st">&quot;Materials &amp; Natural Resources&quot;</span>,</span>
<span id="cb6-130"><a href="#cb6-130" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-131"><a href="#cb6-131" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Miscellaneous</span></span>
<span id="cb6-132"><a href="#cb6-132" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Transaction &amp; Payment Processing Services&quot;</span>: <span class="st">&quot;Miscellaneous&quot;</span>,</span>
<span id="cb6-133"><a href="#cb6-133" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Construction &amp; Engineering&quot;</span>: <span class="st">&quot;Miscellaneous&quot;</span>,</span>
<span id="cb6-134"><a href="#cb6-134" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Homebuilding&quot;</span>: <span class="st">&quot;Miscellaneous&quot;</span></span>
<span id="cb6-135"><a href="#cb6-135" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb6-136"><a href="#cb6-136" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-137"><a href="#cb6-137" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> industry_map.get(sector)</span></code></pre></div>
</div>
<div class="cell code" data-execution_count="7">
<div class="sourceCode" id="cb7"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> display_group(groups_df):</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name, group <span class="kw">in</span> groups_df:</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="sc">{</span>name<span class="sc">}</span><span class="ss">:&quot;</span>)</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>        display(group)</span></code></pre></div>
</div>
<div class="cell code" data-execution_count="8">
<div class="sourceCode" id="cb8"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># map sector to a broader industry</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>ratio_df[<span class="st">&quot;Industry&quot;</span>] <span class="op">=</span> ratio_df[<span class="st">&quot;Sector&quot;</span>].<span class="bu">apply</span>(map_sector_to_industry)</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># All stocks now have an industry. good.</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>ratio_df[<span class="st">&quot;Industry&quot;</span>].isna().<span class="bu">any</span>()</span></code></pre></div>
<div class="output execute_result" data-execution_count="8">
<pre><code>np.False_</code></pre>
</div>
</div>
<section id="removing-missing-gaps-and-empty-columns-in-the-time-series"
class="cell markdown">
<h3>Removing missing gaps and empty columns in the time series</h3>
<p>We handle missing data by identifying and removing large gaps in the
time series. First, we calculate daily percentage change in stock price
(Change) for each ticker, and drop rows where that can't be computed.
Then, we find cases where more than 5 days passed between two trading
dates for the same ticker — which indicates missing data. For each of
those cases, we remove all earlier rows for that ticker to ensure our
analysis starts after the gap. Finally, we drop the first row for each
ticker (which lacks a previous date for comparison).</p>
</section>
<div class="cell code" data-execution_count="9">
<div class="sourceCode" id="cb10"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Problem: there are gaps in the rows where there is up to 300 days between the next day.</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="co"># We need to drop these rows before gap because too much data is missing.</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># calcualte the day change (in percent) for each stock</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>ratio_df[<span class="st">&#39;Change&#39;</span>] <span class="op">=</span> ratio_df.groupby(<span class="st">&#39;Ticker&#39;</span>)[<span class="st">&#39;Close&#39;</span>].pct_change() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="co"># drop the NaN changes (day 0)</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>ratio_df.dropna(subset<span class="op">=</span>[<span class="st">&quot;Change&quot;</span>])</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="co"># find rows that are over 5 days after the previous row for each ticker</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>ratio_df[<span class="st">&#39;Prev_Date&#39;</span>] <span class="op">=</span> ratio_df.groupby(<span class="st">&#39;Ticker&#39;</span>)[<span class="st">&#39;Date&#39;</span>].shift(<span class="dv">1</span>)</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>ratio_df[<span class="st">&#39;Days_Diff&#39;</span>] <span class="op">=</span> (ratio_df[<span class="st">&#39;Date&#39;</span>] <span class="op">-</span> ratio_df[<span class="st">&#39;Prev_Date&#39;</span>]).dt.days</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>over_a_month <span class="op">=</span> ratio_df[ratio_df[<span class="st">&#39;Days_Diff&#39;</span>] <span class="op">&gt;</span> <span class="dv">5</span>]</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="co"># date for each ticker when gap ended</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>dates <span class="op">=</span> {}</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> index, row <span class="kw">in</span> over_a_month.iterrows():</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>    dates[row[<span class="st">&#39;Ticker&#39;</span>]] <span class="op">=</span> row[<span class="st">&#39;Date&#39;</span>] <span class="op">+</span> pd.Timedelta(days<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ticker, date <span class="kw">in</span> dates.items():</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    ratio_df <span class="op">=</span> ratio_df[(ratio_df[<span class="st">&#39;Ticker&#39;</span>] <span class="op">!=</span> ticker) <span class="op">|</span> (ratio_df[<span class="st">&#39;Date&#39;</span>] <span class="op">&gt;=</span> date)]</span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="co"># drop the first day where there is no day difference</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>ratio_df <span class="op">=</span> ratio_df.dropna(subset<span class="op">=</span>[<span class="st">&#39;Days_Diff&#39;</span>])</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Look for columns with unusually low unique values</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> column <span class="kw">in</span> ratio_df.columns:</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    unique_values <span class="op">=</span> ratio_df[column].unique()</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;Column: </span><span class="sc">{</span>column<span class="sc">}</span><span class="ss">, Unique numbers: </span><span class="sc">{</span>unique_values<span class="sc">.</span>size<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>ratio_df.drop(columns<span class="op">=</span>[<span class="st">&quot;EBITDA Margin&quot;</span>], inplace<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Column: Ticker, Unique numbers: 280
Column: Sector, Unique numbers: 101
Column: Industry, Unique numbers: 16
Column: Date, Unique numbers: 3132
Column: Open, Unique numbers: 43827
Column: Close, Unique numbers: 44479
Column: Volume, Unique numbers: 120728
Column: quarter, Unique numbers: 4
Column: year, Unique numbers: 13
Column: Asset Turnover, Unique numbers: 3293
Column: Current Ratio, Unique numbers: 5395
Column: Days Sales In Receivables, Unique numbers: 5866
Column: Debt/Equity Ratio, Unique numbers: 5784
Column: EBIT Margin, Unique numbers: 6499
Column: EBITDA Margin, Unique numbers: 1
Column: Gross Margin, Unique numbers: 5670
Column: Inventory Turnover Ratio, Unique numbers: 4292
Column: Long-term Debt / Capital, Unique numbers: 4486
Column: Net Profit Margin, Unique numbers: 6785
Column: Operating Margin, Unique numbers: 6502
Column: Pre-Tax Profit Margin, Unique numbers: 6809
Column: ROA - Return On Assets, Unique numbers: 4550
Column: ROE - Return On Equity, Unique numbers: 6648
Column: Receiveable Turnover, Unique numbers: 5337
Column: Return On Tangible Equity, Unique numbers: 6695
Column: Change, Unique numbers: 356592
Column: Prev_Date, Unique numbers: 3132
Column: Days_Diff, Unique numbers: 5
</code></pre>
</div>
</div>
<section id="exploratory-data-analysis-and-summary-statistics"
class="cell markdown">
<h1>Exploratory Data Analysis and Summary Statistics</h1>
<p>We will explore the data and summarize the statistics of the data to
help us understand the data better.</p>
<p>The main aspects of the data that we will explore are:</p>
<ul>
<li>Main characteristics of the data</li>
<li>Number of features and entries</li>
<li>Over-representation of a feature</li>
<li>Feaure correlation</li>
<li>Outliers &amp; missing values</li>
</ul>
</section>
<div class="cell code" data-execution_count="10">
<div class="sourceCode" id="cb12"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Basic Data Overview</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Dataset Info:&quot;</span>)</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(ratio_df.info())</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">Basic Statistics:&quot;</span>)</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(ratio_df.describe())</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of Features and Entries</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>num_entries, num_features <span class="op">=</span> ratio_df.shape</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Number of entries: </span><span class="sc">{</span>num_entries<span class="sc">}</span><span class="ss">, Number of features: </span><span class="sc">{</span>num_features<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for missing values</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>missing_values <span class="op">=</span> ratio_df.isnull().<span class="bu">sum</span>()</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">Missing Values:&quot;</span>)</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(missing_values[missing_values <span class="op">&gt;</span> <span class="dv">0</span>])</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="co"># Feature Over-representation</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>categorical_features <span class="op">=</span> [<span class="st">&quot;Sector&quot;</span>, <span class="st">&quot;Industry&quot;</span>] </span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> feature <span class="kw">in</span> categorical_features:</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    feature_counts <span class="op">=</span> ratio_df[feature].value_counts()</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;</span><span class="ch">\n</span><span class="sc">{</span>feature<span class="sc">}</span><span class="ss"> Distribution:&quot;</span>)</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(feature_counts.head(<span class="dv">10</span>))  <span class="co"># Displaying top 10 for readability</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Visualization</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>    sns.barplot(x<span class="op">=</span>feature_counts.index[:<span class="dv">10</span>], y<span class="op">=</span>feature_counts.values[:<span class="dv">10</span>], palette<span class="op">=</span><span class="st">&#39;viridis&#39;</span>, hue<span class="op">=</span>feature_counts.index[:<span class="dv">10</span>])</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>    plt.xticks(rotation<span class="op">=</span><span class="dv">90</span>)</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(feature)</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">&quot;Count&quot;</span>)</span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="ss">f&quot;Distribution of </span><span class="sc">{</span>feature<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Correlation Matrix</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>correlation_matrix <span class="op">=</span> ratio_df.select_dtypes(include<span class="op">=</span>[np.number]).corr()</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">8</span>))</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a>sns.heatmap(correlation_matrix, cmap<span class="op">=</span><span class="st">&quot;coolwarm&quot;</span>, annot<span class="op">=</span><span class="va">False</span>, linewidths<span class="op">=</span><span class="dv">1</span>, vmin<span class="op">=-</span><span class="dv">1</span>, vmax<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&quot;Correlation Matrix of Financial Ratios&quot;</span>)</span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Outlier Detection - Volume</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">5</span>))</span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>sns.boxplot(x<span class="op">=</span>ratio_df[<span class="st">&quot;Volume&quot;</span>])</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a>plt.xscale(<span class="st">&quot;log&quot;</span>)  <span class="co"># Log scale for better visualization</span></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&quot;Volume (Log Scale)&quot;</span>)</span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&quot;Stock Trading Volume Distribution (Log Scale)&quot;</span>)</span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Print out the points with a Volume greater than 10^7 (outlier threshold based on boxplot)</span></span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>outliers <span class="op">=</span> ratio_df[ratio_df[<span class="st">&quot;Volume&quot;</span>] <span class="op">&gt;</span> <span class="fl">1e7</span>]</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;</span><span class="ch">\n</span><span class="ss">Outliers in Volume (</span><span class="sc">{</span><span class="bu">len</span>(outliers)<span class="sc">}</span><span class="ss"> points):&quot;</span>)</span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(outliers)</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a><span class="co"># Finding Date Ranges</span></span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">Date Range:&quot;</span>)</span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Start Date: </span><span class="sc">{</span>ratio_df[<span class="st">&#39;Date&#39;</span>]<span class="sc">.</span><span class="bu">min</span>()<span class="sc">}</span><span class="ss">, End Date: </span><span class="sc">{</span>ratio_df[<span class="st">&#39;Date&#39;</span>]<span class="sc">.</span><span class="bu">max</span>()<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Biggest Volume Day</span></span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a>max_volume_day <span class="op">=</span> ratio_df.loc[ratio_df[<span class="st">&#39;Volume&#39;</span>].idxmax()]</span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">Highest Trading Volume Day:&quot;</span>)</span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(max_volume_day)</span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a><span class="co"># Lowest Volume Day</span></span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a>min_volume_day <span class="op">=</span> ratio_df.loc[ratio_df[<span class="st">&#39;Volume&#39;</span>].idxmin()]</span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;</span><span class="ch">\n</span><span class="st">Lowest Trading Volume Day:&quot;</span>)</span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(min_volume_day)</span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a><span class="co"># Monthly Volume Trends Over Each Month</span></span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a>month_map <span class="op">=</span> {</span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>    <span class="dv">1</span> : <span class="st">&quot;January&quot;</span>,</span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a>    <span class="dv">2</span> : <span class="st">&quot;February&quot;</span>,</span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a>    <span class="dv">3</span> : <span class="st">&quot;March&quot;</span>,</span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a>    <span class="dv">4</span> : <span class="st">&quot;April&quot;</span>,</span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a>    <span class="dv">5</span> : <span class="st">&quot;May&quot;</span>,</span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a>    <span class="dv">6</span> : <span class="st">&quot;June&quot;</span>,</span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a>    <span class="dv">7</span> : <span class="st">&quot;July&quot;</span>,</span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a>    <span class="dv">8</span> : <span class="st">&quot;August&quot;</span>,</span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a>    <span class="dv">9</span> : <span class="st">&quot;September&quot;</span>,</span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a>    <span class="dv">10</span> : <span class="st">&quot;October&quot;</span>,</span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a>    <span class="dv">11</span> : <span class="st">&quot;November&quot;</span>,</span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a>    <span class="dv">12</span> : <span class="st">&quot;December&quot;</span></span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot monthly volume trends across all stocks and years</span></span>
<span id="cb12-83"><a href="#cb12-83" aria-hidden="true" tabindex="-1"></a>ratio_df[<span class="st">&quot;Month&quot;</span>] <span class="op">=</span> ratio_df[<span class="st">&quot;Date&quot;</span>].dt.month.<span class="bu">map</span>(month_map)</span>
<span id="cb12-84"><a href="#cb12-84" aria-hidden="true" tabindex="-1"></a>monthly_volume <span class="op">=</span> ratio_df.groupby(<span class="st">&quot;Month&quot;</span>)[<span class="st">&quot;Volume&quot;</span>].<span class="bu">sum</span>()</span>
<span id="cb12-85"><a href="#cb12-85" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>))</span>
<span id="cb12-86"><a href="#cb12-86" aria-hidden="true" tabindex="-1"></a>sns.lineplot(x<span class="op">=</span>monthly_volume.index.astype(<span class="bu">str</span>), y<span class="op">=</span>monthly_volume.values)</span>
<span id="cb12-87"><a href="#cb12-87" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>, labels<span class="op">=</span>[<span class="st">&quot;January&quot;</span>, <span class="st">&quot;February&quot;</span>, <span class="st">&quot;March&quot;</span>, <span class="st">&quot;April&quot;</span>, <span class="st">&quot;May&quot;</span>, <span class="st">&quot;June&quot;</span>, <span class="st">&quot;July&quot;</span>, <span class="st">&quot;August&quot;</span>, <span class="st">&quot;September&quot;</span>, <span class="st">&quot;October&quot;</span>, <span class="st">&quot;November&quot;</span>, <span class="st">&quot;December&quot;</span>], ticks<span class="op">=</span><span class="bu">range</span>(<span class="dv">0</span>, <span class="dv">12</span>))</span>
<span id="cb12-88"><a href="#cb12-88" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&quot;Month&quot;</span>)</span>
<span id="cb12-89"><a href="#cb12-89" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&quot;Total Volume&quot;</span>)</span>
<span id="cb12-90"><a href="#cb12-90" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&quot;Monthly Trading Volume Trends Across All Stocks and Years&quot;</span>)</span>
<span id="cb12-91"><a href="#cb12-91" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Dataset Info:
&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;
Index: 432845 entries, 1953 to 1048574
Data columns (total 27 columns):
 #   Column                     Non-Null Count   Dtype         
---  ------                     --------------   -----         
 0   Ticker                     432845 non-null  object        
 1   Sector                     432845 non-null  object        
 2   Industry                   432845 non-null  object        
 3   Date                       432845 non-null  datetime64[ns]
 4   Open                       432845 non-null  float64       
 5   Close                      432845 non-null  float64       
 6   Volume                     432845 non-null  int64         
 7   quarter                    432845 non-null  int64         
 8   year                       432845 non-null  int64         
 9   Asset Turnover             432845 non-null  float64       
 10  Current Ratio              432845 non-null  float64       
 11  Days Sales In Receivables  432845 non-null  float64       
 12  Debt/Equity Ratio          432845 non-null  float64       
 13  EBIT Margin                432845 non-null  float64       
 14  Gross Margin               432845 non-null  float64       
 15  Inventory Turnover Ratio   432845 non-null  float64       
 16  Long-term Debt / Capital   432845 non-null  float64       
 17  Net Profit Margin          432845 non-null  float64       
 18  Operating Margin           432845 non-null  float64       
 19  Pre-Tax Profit Margin      432845 non-null  float64       
 20  ROA - Return On Assets     301027 non-null  float64       
 21  ROE - Return On Equity     432590 non-null  float64       
 22  Receiveable Turnover       432845 non-null  float64       
 23  Return On Tangible Equity  428225 non-null  float64       
 24  Change                     432845 non-null  float64       
 25  Prev_Date                  432845 non-null  datetime64[ns]
 26  Days_Diff                  432845 non-null  float64       
dtypes: datetime64[ns](2), float64(19), int64(3), object(3)
memory usage: 92.5+ MB
None

Basic Statistics:
                                Date           Open          Close  \
count                         432845  432845.000000  432845.000000   
mean   2017-08-11 03:03:12.498469376     106.137836     106.157700   
min              2008-04-24 00:00:00       1.620000       1.620000   
25%              2016-02-18 00:00:00      39.380000      39.380000   
50%              2017-09-01 00:00:00      65.920000      65.940000   
75%              2019-03-20 00:00:00     110.460000     110.480000   
max              2020-09-30 00:00:00    3547.000000    3531.450000   
std                              NaN     172.241553     172.252719   

             Volume        quarter           year  Asset Turnover  \
count  4.328450e+05  432845.000000  432845.000000   432845.000000   
mean   5.275222e+06       2.511733    2017.109413        0.179139   
min    0.000000e+00       1.000000    2008.000000       -0.255800   
25%    1.010500e+06       2.000000    2016.000000        0.072500   
50%    2.112100e+06       3.000000    2017.000000        0.137500   
75%    4.689100e+06       3.000000    2019.000000        0.223800   
max    6.488252e+08       4.000000    2020.000000        1.192600   
std    1.389292e+07       1.111781       1.947355        0.165962   

       Current Ratio  Days Sales In Receivables  Debt/Equity Ratio  \
count  432845.000000              432845.000000      432845.000000   
mean        1.557008                  51.384821           0.678633   
min         0.000000               -1071.780000       -1294.600000   
25%         0.795700                  23.882700           0.390100   
50%         1.297600                  45.656600           0.806500   
75%         1.957400                  62.619600           1.372800   
max        16.402100                2114.080000         834.733000   
std         1.410264                  84.378794          29.864951   

         EBIT Margin   Gross Margin  Inventory Turnover Ratio  \
count  432845.000000  432845.000000             432845.000000   
mean       11.204009      41.758422                  2.396857   
min     -7943.890000   -2817.410000                 -3.714900   
25%         7.388900      20.960500                  0.000000   
50%        15.148700      40.296600                  0.898000   
75%        23.084700      64.446200                  1.790800   
max      1578.790000     532.653000                783.557000   
std       144.952175      56.513819                 13.736687   

       Long-term Debt / Capital  Net Profit Margin  Operating Margin  \
count             432845.000000      432845.000000     432845.000000   
mean                   0.485153           7.002041         11.279483   
min                    0.000000      -10392.200000      -7943.890000   
25%                    0.280500           4.989200          7.391600   
50%                    0.440400          10.749800         15.146800   
75%                    0.577600          18.050600         23.046300   
max                   36.890000        1238.380000       1578.790000   
std                    0.734282         180.766887        144.983930   

       Pre-Tax Profit Margin  ROA - Return On Assets  ROE - Return On Equity  \
count          432845.000000           301027.000000           432590.000000   
mean                9.785126                1.674212                5.025111   
min            -10449.900000              -17.113300           -12220.000000   
25%                 6.897800                0.535400                1.645600   
50%                13.823800                1.355600                3.599900   
75%                22.552700                2.638100                6.594400   
max              1591.920000               36.407400             3694.120000   
std               181.747710                2.386383              215.342602   

       Receiveable Turnover  Return On Tangible Equity         Change  \
count         432845.000000              428225.000000  432845.000000   
mean               3.505060                   3.503797       0.061975   
min               -3.083500               -9211.610000     -53.868613   
25%                1.165900                  -5.060200      -0.739463   
50%                1.639300                   2.441700       0.085763   
75%                2.340400                   7.637000       0.904033   
max              772.606000               19186.700000      67.956692   
std               20.101458                 398.750409       1.985636   

                           Prev_Date      Days_Diff  
count                         432845  432845.000000  
mean   2017-08-09 16:13:44.720164864       1.451016  
min              2008-04-23 00:00:00       1.000000  
25%              2016-02-17 00:00:00       1.000000  
50%              2017-08-31 00:00:00       1.000000  
75%              2019-03-19 00:00:00       1.000000  
max              2020-09-29 00:00:00       5.000000  
std                              NaN       0.875059  
Number of entries: 432845, Number of features: 27

Missing Values:
ROA - Return On Assets       131818
ROE - Return On Equity          255
Return On Tangible Equity      4620
dtype: int64

Sector Distribution:
Sector
Health Care Equipment                 15100
Packaged Foods &amp; Meats                14377
Electric Utilities                    13590
Specialty Chemicals                   11685
Multi-Utilities                       11640
Financial Exchanges &amp; Data            11588
Semiconductors                        10357
Hotels, Resorts &amp; Cruise Lines         9689
Oil &amp; Gas Exploration &amp; Production     9553
Aerospace &amp; Defense                    9422
Name: count, dtype: int64
</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_3029dff3b32943149bfb6de06d795b6a/3db9d0456af509650eb43c2c02a430e03845f66d.png" /></p>
</div>
<div class="output stream stdout">
<pre><code>
Industry Distribution:
Industry
Technology &amp; Software             71547
Industrials &amp; Manufacturing       64079
Health Care &amp; Life Sciences       56705
Energy &amp; Utilities                51731
Financial Services                47007
Consumer Goods                    29477
Retail                            22650
Real Estate (REITs)               22650
Media, Entertainment &amp; Leisure    20259
Transportation &amp; Logistics        10570
Name: count, dtype: int64
</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_3029dff3b32943149bfb6de06d795b6a/324d28c6a2cc566574e8266d946f04d9b5b1ac22.png" /></p>
</div>
<div class="output display_data">
<p><img
src="vertopal_3029dff3b32943149bfb6de06d795b6a/68a59dcdeae10011e0cc8ddfa4d0b07dce9e4642.png" /></p>
</div>
<div class="output display_data">
<p><img
src="vertopal_3029dff3b32943149bfb6de06d795b6a/5a07dcf72d2cfcfb9eff39679b7f915a2b3ae631.png" /></p>
</div>
<div class="output stream stdout">
<pre><code>
Outliers in Volume (43819 points):
        Ticker                                      Sector  \
2863         A              Life Sciences Tools &amp; Services   
3114         A              Life Sciences Tools &amp; Services   
12218     AAPL  Technology Hardware, Storage &amp; Peripherals   
12219     AAPL  Technology Hardware, Storage &amp; Peripherals   
12220     AAPL  Technology Hardware, Storage &amp; Peripherals   
...        ...                                         ...   
1048374     NI                             Multi-Utilities   
1048500     NI                             Multi-Utilities   
1048501     NI                             Multi-Utilities   
1048505     NI                             Multi-Utilities   
1048545     NI                             Multi-Utilities   

                            Industry       Date   Open  Close     Volume  \
2863     Health Care &amp; Life Sciences 2018-05-15  60.50  61.14   14451200   
3114     Health Care &amp; Life Sciences 2019-05-15  66.50  66.77   14523800   
12218          Technology &amp; Software 2014-10-02  22.33  22.47  191031200   
12219          Technology &amp; Software 2014-10-03  22.37  22.41  173878400   
12220          Technology &amp; Software 2014-10-06  22.48  22.41  148204800   
...                              ...        ...    ...    ...        ...   
1048374           Energy &amp; Utilities 2018-03-16  21.49  21.53   13341100   
1048500           Energy &amp; Utilities 2018-09-14  23.82  23.14   33151100   
1048501           Energy &amp; Utilities 2018-09-17  23.15  24.02   15104500   
1048505           Energy &amp; Utilities 2018-09-21  23.32  23.85   11601900   
1048545           Energy &amp; Utilities 2018-11-16  24.05  24.16   10117200   

         quarter  year  Asset Turnover  Current Ratio  \
2863           2  2018          0.1373         3.3150   
3114           2  2019          0.1372         3.4097   
12218          4  2014          0.2848         1.1330   
12219          4  2014          0.2848         1.1330   
12220          4  2014          0.2848         1.1330   
...          ...   ...             ...            ...   
1048374        1  2018          0.0871         0.5064   
1048500        3  2018          0.0432         0.4014   
1048501        3  2018          0.0432         0.4014   
1048505        3  2018          0.0432         0.4014   
1048545        4  2018          0.0670         0.5092   

         Days Sales In Receivables  Debt/Equity Ratio  EBIT Margin  \
2863                       56.2687             0.4581      17.4129   
3114                       59.5396             0.3508      17.4475   
12218                      36.1646             0.2952      32.5018   
12219                      36.1646             0.2952      32.5018   
12220                      36.1646             0.2952      32.5018   
...                            ...                ...          ...   
1048374                    52.8136             2.0232      22.8810   
1048500                    54.0704             1.7254     -35.2961   
1048501                    54.0704             1.7254     -35.2961   
1048505                    54.0704             1.7254     -35.2961   
1048545                    70.6171             1.5880      -5.3636   

         Gross Margin  Inventory Turnover Ratio  Long-term Debt / Capital  \
2863          53.3168                    0.9478                    0.2805   
3114          54.0388                    0.8661                    0.2597   
12218         39.8678                   19.6487                    0.2086   
12219         39.8678                   19.6487                    0.2086   
12220         39.8678                   19.6487                    0.2086   
...               ...                       ...                       ...   
1048374       58.6246                    2.9531                    0.6179   
1048500       75.1955                    0.4755                    0.5830   
1048501       75.1955                    0.4755                    0.5830   
1048505       75.1955                    0.4755                    0.5830   
1048545       65.6838                    1.1872                    0.5527   

         Net Profit Margin  Operating Margin  Pre-Tax Profit Margin  \
2863               16.9983           17.4129                18.8226   
3114               14.7011           17.4475                17.6091   
12218              24.1612           32.5018                32.7297   
12219              24.1612           32.5018                32.7297   
12220              24.1612           32.5018                32.7297   
...                    ...               ...                    ...   
1048374            15.7699           22.8810                19.3512   
1048500           -38.5587          -35.2961               -48.4916   
1048501           -38.5587          -35.2961               -48.4916   
1048505           -38.5587          -35.2961               -48.4916   
1048545            -1.3546           -5.3636               -11.3156   

         ROA - Return On Assets  ROE - Return On Equity  Receiveable Turnover  \
2863                     2.3338                  4.4401                1.5995   
3114                        NaN                  3.5512                1.5116   
12218                    6.8822                 14.6147                2.4886   
12219                    6.8822                 14.6147                2.4886   
12220                    6.8822                 14.6147                2.4886   
...                         ...                     ...                   ...   
1048374                  1.3737                  6.1271                1.7041   
1048500                 -1.6401                 -7.2546                1.6645   
1048501                 -1.6401                 -7.2546                1.6645   
1048505                 -1.6401                 -7.2546                1.6645   
1048545                     NaN                 -0.2402                1.2745   

         Return On Tangible Equity     Change  Prev_Date  Days_Diff  
2863                       12.1662  -9.703146 2018-05-14        1.0  
3114                       12.3390 -11.020789 2019-05-14        1.0  
12218                      15.7650   0.717167 2014-10-01        1.0  
12219                      15.7650  -0.267023 2014-10-02        1.0  
12220                      15.7650   0.000000 2014-10-03        3.0  
...                            ...        ...        ...        ...  
1048374                    10.6742   0.186133 2018-03-15        1.0  
1048500                   -10.7454 -11.713087 2018-09-13        1.0  
1048501                   -10.7454   3.802939 2018-09-14        3.0  
1048505                   -10.7454   1.273885 2018-09-20        1.0  
1048545                    -0.3047   1.512605 2018-11-15        1.0  

[43819 rows x 27 columns]

Date Range:
Start Date: 2008-04-24 00:00:00, End Date: 2020-09-30 00:00:00

Highest Trading Volume Day:
Ticker                                                             AAPL
Sector                       Technology Hardware, Storage &amp; Peripherals
Industry                                          Technology &amp; Software
Date                                                2015-08-24 00:00:00
Open                                                               21.7
Close                                                             23.59
Volume                                                        648825200
quarter                                                               3
year                                                               2015
Asset Turnover                                                   0.1774
Current Ratio                                                    1.1088
Days Sales In Receivables                                       53.0256
Debt/Equity Ratio                                                 0.539
EBIT Margin                                                     28.3936
Gross Margin                                                    39.8983
Inventory Turnover Ratio                                        13.1771
Long-term Debt / Capital                                         0.3088
Net Profit Margin                                               21.5996
Operating Margin                                                28.3936
Pre-Tax Profit Margin                                            29.246
ROA - Return On Assets                                           3.8313
ROE - Return On Equity                                           9.3201
Receiveable Turnover                                             1.6973
Return On Tangible Equity                                        10.081
Change                                                        -2.480364
Prev_Date                                           2015-08-21 00:00:00
Days_Diff                                                           3.0
Name: 12442, dtype: object

Lowest Trading Volume Day:
Ticker                                                                 AMCR
Sector                       Paper &amp; Plastic Packaging Products &amp; Materials
Industry                                        Industrials &amp; Manufacturing
Date                                                    2014-10-02 00:00:00
Open                                                                   8.09
Close                                                                  8.09
Volume                                                                    0
quarter                                                                   4
year                                                                   2014
Asset Turnover                                                          0.0
Current Ratio                                                           0.0
Days Sales In Receivables                                               0.0
Debt/Equity Ratio                                                       0.0
EBIT Margin                                                             0.0
Gross Margin                                                            0.0
Inventory Turnover Ratio                                                0.0
Long-term Debt / Capital                                                0.0
Net Profit Margin                                                       0.0
Operating Margin                                                        0.0
Pre-Tax Profit Margin                                                   0.0
ROA - Return On Assets                                                  0.0
ROE - Return On Equity                                                  0.0
Receiveable Turnover                                                    0.0
Return On Tangible Equity                                               0.0
Change                                                                  0.0
Prev_Date                                               2014-10-01 00:00:00
Days_Diff                                                               1.0
Name: 97523, dtype: object
</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_3029dff3b32943149bfb6de06d795b6a/d3576163887ad3a03d4ddb08ce7193446e5eb3c8.png" /></p>
</div>
</div>
<section
id="is-there-a-relationship-between-the-debt-equity-ratio-and-return-on-equity"
class="cell markdown">
<h3>Is there a relationship between the Debt-Equity Ratio and Return on
Equity?</h3>
<p>We use linear regression to analyze the relationship between a
company’s Debt/Equity Ratio and its Return on Equity (ROE). After
isolating the debt/equity ratio and ROE from the data, we fit a simple
regression model and visualize the best-fit line over the data points.
We then evaluate the strength of the relationship using the R-squared
value, and perform a hypothesis test on the slope to determine if the
relationship is statistically significant. Finally, we print the slope,
t-statistic, p-value, and conclude whether or not to reject the null
hypothesis based on an alpha level of 0.05.</p>
</section>
<div class="cell code" data-execution_count="11">
<div class="sourceCode" id="cb16"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LinearRegression</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>ratio_df.columns</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>relationship_df <span class="op">=</span> ratio_df[[<span class="st">&#39;Debt/Equity Ratio&#39;</span>, <span class="st">&#39;ROE - Return On Equity&#39;</span>]]</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>relationship_df <span class="op">=</span> relationship_df.dropna()</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Define X and y</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> relationship_df[[<span class="st">&quot;Debt/Equity Ratio&quot;</span>]]  <span class="co"># scikit-learn requires X to be a 2D array</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> relationship_df[<span class="st">&quot;ROE - Return On Equity&quot;</span>]</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the model</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> LinearRegression()</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>model.fit(X, y)</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Get slope (coefficient) and intercept</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>beta_1 <span class="op">=</span> model.coef_[<span class="dv">0</span>]</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>beta_0 <span class="op">=</span> model.intercept_</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Generate predictions for the regression line</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>X_range <span class="op">=</span> np.linspace(X.<span class="bu">min</span>(), X.<span class="bu">max</span>(), <span class="dv">100</span>).reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> model.predict(X_range)</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the data points</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>plt.scatter(X, y, color<span class="op">=</span><span class="st">&quot;blue&quot;</span>, label<span class="op">=</span><span class="st">&quot;Actual Data&quot;</span>)</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the regression line</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>plt.plot(X_range, y_pred, color<span class="op">=</span><span class="st">&quot;red&quot;</span>, linewidth<span class="op">=</span><span class="dv">2</span>, label<span class="op">=</span><span class="st">&quot;Regression Line&quot;</span>)</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Labels and title</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&quot;Debt/Equity Ratio&quot;</span>)</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&quot;ROE - Return On Equity&quot;</span>)</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&quot;Linear Regression (scikit-learn)&quot;</span>)</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Print R-squared value</span></span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>r_squared <span class="op">=</span> model.score(X, y)</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;R-squared: </span><span class="sc">{</span>r_squared<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Predictions</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>y_pred <span class="op">=</span> model.predict(X)</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Residuals</span></span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>residuals <span class="op">=</span> y <span class="op">-</span> y_pred</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Degrees of freedom (n - 2 for simple linear regression)</span></span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> <span class="bu">len</span>(y) <span class="op">-</span> <span class="dv">2</span></span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Residual standard error (sigma)</span></span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>sigma <span class="op">=</span> np.sqrt(np.<span class="bu">sum</span>(residuals<span class="op">**</span><span class="dv">2</span>) <span class="op">/</span> df)</span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Standard error of the slope</span></span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>SE_beta_1 <span class="op">=</span> sigma <span class="op">/</span> np.sqrt(np.<span class="bu">sum</span>((X.values.flatten() <span class="op">-</span> np.mean(X.values.flatten()))<span class="op">**</span><span class="dv">2</span>))</span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute t-statistic</span></span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>t_stat <span class="op">=</span> beta_1 <span class="op">/</span> SE_beta_1</span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a><span class="co"># Compute two-tailed p-value</span></span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>p_value <span class="op">=</span> <span class="dv">2</span> <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> stats.t.cdf(<span class="bu">abs</span>(t_stat), df))</span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a><span class="co">#H0 and Ha</span></span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Null Hypothesis: There is no significant relationship between Debt to Equity Ratio and Return on Equity.&quot;</span>)</span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Alternative Hypothesis: There is a significant relationship between Debt to Equity Ratio and Return on Equity.&quot;</span>)</span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Alpha-value is 0.05 &quot;</span>)</span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a><span class="co"># Print results</span></span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Slope (β1): </span><span class="sc">{</span>beta_1<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;T-statistic: </span><span class="sc">{</span>t_stat<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;P-value: </span><span class="sc">{</span>p_value<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Conclusion:&quot;</span>)</span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a><span class="co"># Interpretation</span></span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a>alpha <span class="op">=</span> <span class="fl">0.05</span></span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> p_value <span class="op">&lt;</span> alpha:</span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;The relationship is statistically significant (reject H0) since p-value &lt; alpha.&quot;</span>)</span>
<span id="cb16-76"><a href="#cb16-76" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;The relationship is NOT statistically significant (fail to reject H0) since p-value &gt;= alpha.&quot;</span>)</span>
<span id="cb16-78"><a href="#cb16-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-79"><a href="#cb16-79" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="output stream stderr">
<pre><code>c:\Users\zhong\AppData\Local\Programs\Python\Python310\lib\site-packages\sklearn\base.py:493: UserWarning: X does not have valid feature names, but LinearRegression was fitted with feature names
  warnings.warn(
</code></pre>
</div>
<div class="output stream stdout">
<pre><code>R-squared: 0.5582146926564454
Null Hypothesis: There is no significant relationship between Debt to Equity Ratio and Return on Equity.
Alternative Hypothesis: There is a significant relationship between Debt to Equity Ratio and Return on Equity.
Alpha-value is 0.05 
Slope (β1): 5.385683401189787
T-statistic: 739.3196197689472
P-value: 0.0
Conclusion:
The relationship is statistically significant (reject H0) since p-value &lt; alpha.
</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_3029dff3b32943149bfb6de06d795b6a/ef7f328c6fc5355fea78d223684e89cddcf6c90c.png" /></p>
</div>
</div>
<div class="cell markdown">
<p>Great! There is a significant relationship between Debt to Equity
Ratio and Return on Equity</p>
</div>
<div class="cell code" data-execution_count="12">
<div class="sourceCode" id="cb19"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Maybe check if theres relationship between gross profit margin and growth</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> pearsonr</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract pretax profit and ROA</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>pre_tax_profit_margin <span class="op">=</span> ratio_df[<span class="st">&quot;Pre-Tax Profit Margin&quot;</span>].dropna()</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>return_on_assets <span class="op">=</span> ratio_df[<span class="st">&quot;ROA - Return On Assets&quot;</span>].dropna()</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="co"># x and y need to be same length</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>common_index <span class="op">=</span> pre_tax_profit_margin.index.intersection(return_on_assets.index)</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>pre_tax_profit_margin <span class="op">=</span> pre_tax_profit_margin.loc[common_index]</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>return_on_assets <span class="op">=</span> return_on_assets.loc[common_index]</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a><span class="co"># calculate pearson correlation</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>correlation, p_value <span class="op">=</span> pearsonr(pre_tax_profit_margin, return_on_assets)</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Pearson correlation coefficient: </span><span class="sc">{</span>correlation<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;P-value: </span><span class="sc">{</span>p_value<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">8</span>, <span class="dv">6</span>))</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a>plt.scatter(pre_tax_profit_margin, return_on_assets, alpha<span class="op">=</span><span class="fl">0.5</span>, color<span class="op">=</span><span class="st">&#39;blue&#39;</span>, label<span class="op">=</span><span class="st">&quot;Data Points&quot;</span>)</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a><span class="co"># regression line</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>slope, intercept <span class="op">=</span> np.polyfit(pre_tax_profit_margin, return_on_assets, <span class="dv">1</span>)</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>regression_line <span class="op">=</span> slope <span class="op">*</span> pre_tax_profit_margin <span class="op">+</span> intercept</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot line</span></span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>plt.plot(pre_tax_profit_margin, regression_line, color<span class="op">=</span><span class="st">&#39;red&#39;</span>, label<span class="op">=</span><span class="st">&quot;Regression Line&quot;</span>)</span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&quot;Pre-Tax Profit Margin vs ROA with Regression Line&quot;</span>)</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&quot;Pre-Tax Profit Margin&quot;</span>)</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&quot;ROA - Return On Assets&quot;</span>)</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;A pearson r of </span><span class="sc">{</span>correlation<span class="sc">}</span><span class="ss"> indicates a moderate linear relationship&quot;</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Pearson correlation coefficient: 0.5111903025830772
P-value: 0.0
</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_3029dff3b32943149bfb6de06d795b6a/94f77b37d50f21209d5e4e1d9e73f8644a8a3dbd.png" /></p>
</div>
<div class="output stream stdout">
<pre><code>A pearson r of 0.5111903025830772 indicates a moderate linear relationship
</code></pre>
</div>
</div>
<div class="cell code" data-execution_count="13">
<div class="sourceCode" id="cb22"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>ratio_df.insert(<span class="dv">4</span>, <span class="st">&quot;fiscal quarter&quot;</span>, <span class="st">&quot;Q&quot;</span> <span class="op">+</span> ratio_df[<span class="st">&quot;quarter&quot;</span>].astype(<span class="bu">str</span>) <span class="op">+</span> <span class="st">&quot;-&quot;</span> <span class="op">+</span> ratio_df[<span class="st">&quot;year&quot;</span>].astype(<span class="bu">str</span>))</span></code></pre></div>
</div>
<section
id="exploring-relationships-between-changes-in-financial-ratios-and-changes-in-share-price-year-over-year"
class="cell markdown">
<h3>Exploring relationships between changes in financial ratios and
changes in share price year-over-year</h3>
</section>
<div class="cell code" data-execution_count="14">
<div class="sourceCode" id="cb23"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># list of ratio columns to analyze</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>ratio_columns <span class="op">=</span> [</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Asset Turnover&quot;</span>, <span class="st">&quot;Current Ratio&quot;</span>, <span class="st">&quot;Days Sales In Receivables&quot;</span>, </span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Debt/Equity Ratio&quot;</span>, <span class="st">&quot;EBIT Margin&quot;</span>, <span class="st">&quot;Gross Margin&quot;</span>, </span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Inventory Turnover Ratio&quot;</span>, <span class="st">&quot;Long-term Debt / Capital&quot;</span>, <span class="st">&quot;Net Profit Margin&quot;</span>, </span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Operating Margin&quot;</span>, <span class="st">&quot;Pre-Tax Profit Margin&quot;</span>, <span class="st">&quot;ROA - Return On Assets&quot;</span>, </span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;ROE - Return On Equity&quot;</span>, <span class="st">&quot;Receiveable Turnover&quot;</span>, <span class="st">&quot;Return On Tangible Equity&quot;</span></span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>ratio_df[<span class="st">&quot;Year&quot;</span>] <span class="op">=</span> ratio_df[<span class="st">&quot;Date&quot;</span>].dt.year</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>grouped <span class="op">=</span> ratio_df.groupby([<span class="st">&quot;Ticker&quot;</span>, <span class="st">&quot;Year&quot;</span>]).tail(<span class="dv">1</span>).copy()</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>grouped[<span class="st">&quot;1YChange&quot;</span>] <span class="op">=</span> grouped.groupby(<span class="st">&quot;Ticker&quot;</span>)[<span class="st">&quot;Close&quot;</span>].pct_change() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>correlation_results <span class="op">=</span> []</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> ratio_columns:</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>    change_col <span class="op">=</span> <span class="ss">f&quot;1Y_</span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">_Change&quot;</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a>    grouped[change_col] <span class="op">=</span> grouped.groupby(<span class="st">&quot;Ticker&quot;</span>)[col].pct_change() <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a>    valid_data <span class="op">=</span> grouped[[<span class="st">&quot;1YChange&quot;</span>, change_col]].dropna()</span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># drop any rows with inf</span></span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>    valid_data <span class="op">=</span> valid_data.replace([np.inf, <span class="op">-</span>np.inf], np.nan).dropna()</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># calculate Pearson correlation</span></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>    r, p <span class="op">=</span> pearsonr(valid_data[<span class="st">&quot;1YChange&quot;</span>], valid_data[change_col])</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># put it into a dict that will be turned into a dataframe later</span></span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>    correlation_results.append({</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Ratio&quot;</span>: col,</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;Pearson r&quot;</span>: <span class="bu">round</span>(r, <span class="dv">2</span>),</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;P-value&quot;</span> : <span class="bu">round</span>(p_value, <span class="dv">2</span>)</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>correlation_df <span class="op">=</span> pd.DataFrame(correlation_results).sort_values(<span class="st">&quot;Pearson r&quot;</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a>heatmap_data <span class="op">=</span> correlation_df.set_index(<span class="st">&quot;Ratio&quot;</span>)[[<span class="st">&quot;Pearson r&quot;</span>]]</span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">5</span>, <span class="dv">8</span>))</span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>sns.heatmap(heatmap_data, annot<span class="op">=</span><span class="va">True</span>, cmap<span class="op">=</span><span class="st">&quot;coolwarm&quot;</span>, center<span class="op">=</span><span class="dv">0</span>, cbar_kws<span class="op">=</span>{<span class="st">&quot;label&quot;</span>: <span class="st">&quot;Pearson r&quot;</span>})</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&quot;Correlation between 1Y Price Change and Ratio Changes&quot;</span>)</span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="output display_data">
<p><img
src="vertopal_3029dff3b32943149bfb6de06d795b6a/961d79f33005210fe41470b7bfdec7dcdcad9601.png" /></p>
</div>
</div>
<div class="cell markdown">
<p>As we can see, there are not any significant correlations between
ratio changes and price changes over 1 year. The R values range between
-0.11 and 0.13 which indicate little to no correlation.</p>
</div>
<section
id="has-any-industry-grown-more-than-the-others-in-the-past-5-years"
class="cell markdown">
<h1>Has any industry grown more than the others in the past 5
years?</h1>
</section>
<div class="cell code" data-execution_count="15">
<div class="sourceCode" id="cb24"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> ttest_ind</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure &#39;Date&#39; is in datetime format</span></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>ratio_df[<span class="st">&#39;Date&#39;</span>] <span class="op">=</span> pd.to_datetime(ratio_df[<span class="st">&#39;Date&#39;</span>])</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter data for the last 5 years</span></span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a>today <span class="op">=</span> ratio_df[<span class="st">&#39;Date&#39;</span>].<span class="bu">max</span>()</span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>five_years_ago <span class="op">=</span> today <span class="op">-</span> pd.DateOffset(years<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>filtered_data <span class="op">=</span> ratio_df[(ratio_df[<span class="st">&#39;Date&#39;</span>] <span class="op">&gt;=</span> five_years_ago) <span class="op">&amp;</span> (ratio_df[<span class="st">&#39;Date&#39;</span>] <span class="op">&lt;=</span> today)]</span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Group by Industry and Date (daily intervals), and calculate average daily returns (Change)</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>daily_avg_returns <span class="op">=</span> (</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>    filtered_data.groupby([<span class="st">&#39;Industry&#39;</span>, <span class="st">&#39;Date&#39;</span>])[<span class="st">&#39;Change&#39;</span>]</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>    .mean()</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb24-17"><a href="#cb24-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-18"><a href="#cb24-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-19"><a href="#cb24-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the average growth for each industry over 5 years</span></span>
<span id="cb24-20"><a href="#cb24-20" aria-hidden="true" tabindex="-1"></a>avg_growth_by_industry <span class="op">=</span> (</span>
<span id="cb24-21"><a href="#cb24-21" aria-hidden="true" tabindex="-1"></a>    daily_avg_returns.groupby(<span class="st">&#39;Industry&#39;</span>)[<span class="st">&#39;Change&#39;</span>]</span>
<span id="cb24-22"><a href="#cb24-22" aria-hidden="true" tabindex="-1"></a>    .mean()</span>
<span id="cb24-23"><a href="#cb24-23" aria-hidden="true" tabindex="-1"></a>    .sort_values(ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb24-24"><a href="#cb24-24" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb24-25"><a href="#cb24-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-26"><a href="#cb24-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify the industry with the largest average growth</span></span>
<span id="cb24-27"><a href="#cb24-27" aria-hidden="true" tabindex="-1"></a>industry_with_largest_avg_growth <span class="op">=</span> avg_growth_by_industry.idxmax()</span>
<span id="cb24-28"><a href="#cb24-28" aria-hidden="true" tabindex="-1"></a>largest_avg_growth <span class="op">=</span> avg_growth_by_industry.<span class="bu">max</span>()</span>
<span id="cb24-29"><a href="#cb24-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-30"><a href="#cb24-30" aria-hidden="true" tabindex="-1"></a><span class="co"># Separate the growth of the largest-growth industry and all other industries</span></span>
<span id="cb24-31"><a href="#cb24-31" aria-hidden="true" tabindex="-1"></a>largest_growth_values <span class="op">=</span> daily_avg_returns[daily_avg_returns[<span class="st">&#39;Industry&#39;</span>] <span class="op">==</span> industry_with_largest_avg_growth][<span class="st">&#39;Change&#39;</span>]</span>
<span id="cb24-32"><a href="#cb24-32" aria-hidden="true" tabindex="-1"></a>other_growth_values <span class="op">=</span> daily_avg_returns[daily_avg_returns[<span class="st">&#39;Industry&#39;</span>] <span class="op">!=</span> industry_with_largest_avg_growth][<span class="st">&#39;Change&#39;</span>]</span>
<span id="cb24-33"><a href="#cb24-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-34"><a href="#cb24-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Perform a two-sample t-test</span></span>
<span id="cb24-35"><a href="#cb24-35" aria-hidden="true" tabindex="-1"></a>t_stat, p_value <span class="op">=</span> ttest_ind(largest_growth_values, other_growth_values, alternative<span class="op">=</span><span class="st">&#39;greater&#39;</span>)</span>
<span id="cb24-36"><a href="#cb24-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-37"><a href="#cb24-37" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the results</span></span>
<span id="cb24-38"><a href="#cb24-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;Average daily growth over 5 years for each industry:&quot;</span>)</span>
<span id="cb24-39"><a href="#cb24-39" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(avg_growth_by_industry)</span>
<span id="cb24-40"><a href="#cb24-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-41"><a href="#cb24-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;</span><span class="ch">\n</span><span class="ss">Industry with the largest average growth over 5 years: </span><span class="sc">{</span>industry_with_largest_avg_growth<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb24-42"><a href="#cb24-42" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Largest average growth value: </span><span class="sc">{</span>largest_avg_growth<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb24-43"><a href="#cb24-43" aria-hidden="true" tabindex="-1"></a>avg_growth_excluding_largest <span class="op">=</span> avg_growth_by_industry.drop(industry_with_largest_avg_growth).mean()</span>
<span id="cb24-44"><a href="#cb24-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-45"><a href="#cb24-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the result</span></span>
<span id="cb24-46"><a href="#cb24-46" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;</span><span class="ch">\n</span><span class="ss">Average of the average growth of all industries excluding the largest growth: </span><span class="sc">{</span>avg_growth_excluding_largest<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb24-47"><a href="#cb24-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-48"><a href="#cb24-48" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;</span><span class="ch">\n</span><span class="ss">T-statistic: </span><span class="sc">{</span>t_stat<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb24-49"><a href="#cb24-49" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;P-value: </span><span class="sc">{</span>p_value<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb24-50"><a href="#cb24-50" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">&quot;alpha value =  0.05&quot;</span>)</span>
<span id="cb24-51"><a href="#cb24-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-52"><a href="#cb24-52" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> p_value <span class="op">&lt;</span> <span class="fl">0.05</span>:</span>
<span id="cb24-53"><a href="#cb24-53" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;The growth of the industry with the largest average growth is significantly different from the average growth of all other industries.&quot;</span>)</span>
<span id="cb24-54"><a href="#cb24-54" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb24-55"><a href="#cb24-55" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">&quot;The growth of the industry with the largest average growth is not significantly different from the average growth of all other industries.&quot;</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Average daily growth over 5 years for each industry:
Industry
Materials &amp; Natural Resources        0.130048
Technology &amp; Software                0.106258
Real Estate Services &amp; Consulting    0.097863
Miscellaneous                        0.096448
Telecommunications                   0.091295
Retail                               0.088456
Agriculture                          0.075895
Health Care &amp; Life Sciences          0.075247
Industrials &amp; Manufacturing          0.066194
Transportation &amp; Logistics           0.059278
Media, Entertainment &amp; Leisure       0.050790
Consumer Goods                       0.047960
Financial Services                   0.042838
Real Estate (REITs)                  0.042389
Energy &amp; Utilities                   0.035313
Automotive                           0.033361
Name: Change, dtype: float64

Industry with the largest average growth over 5 years: Materials &amp; Natural Resources
Largest average growth value: 0.13004794740946238

Average of the average growth of all industries excluding the largest growth: 0.06730566603484786

T-statistic: 1.359211505863748
P-value: 0.08704739093082645
alpha value =  0.05
The growth of the industry with the largest average growth is not significantly different from the average growth of all other industries.
</code></pre>
</div>
</div>
<div class="cell code" data-execution_count="16">
<div class="sourceCode" id="cb26"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.dates <span class="im">as</span> mdates</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Ensure &#39;Date&#39; is in datetime format</span></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>ratio_df[<span class="st">&#39;Date&#39;</span>] <span class="op">=</span> pd.to_datetime(ratio_df[<span class="st">&#39;Date&#39;</span>])</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Filter data for the last 5 years</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>today <span class="op">=</span> ratio_df[<span class="st">&#39;Date&#39;</span>].<span class="bu">max</span>()</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>five_years_ago <span class="op">=</span> today <span class="op">-</span> pd.DateOffset(years<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>filtered_data <span class="op">=</span> ratio_df[(ratio_df[<span class="st">&#39;Date&#39;</span>] <span class="op">&gt;=</span> five_years_ago) <span class="op">&amp;</span> (ratio_df[<span class="st">&#39;Date&#39;</span>] <span class="op">&lt;=</span> today)]</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Group by Industry and Date (daily intervals)</span></span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a>daily_avg_returns <span class="op">=</span> (</span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>    filtered_data.groupby([<span class="st">&#39;Industry&#39;</span>, <span class="st">&#39;Date&#39;</span>])[<span class="st">&#39;Change&#39;</span>]</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    .mean()</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    .reset_index()</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Pivot the data to have industries as columns and days as rows</span></span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a>pivot_data <span class="op">=</span> daily_avg_returns.pivot(index<span class="op">=</span><span class="st">&#39;Date&#39;</span>, columns<span class="op">=</span><span class="st">&#39;Industry&#39;</span>, values<span class="op">=</span><span class="st">&#39;Change&#39;</span>)</span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the average growth over 5 years for each industry</span></span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a>industry_avg_growth <span class="op">=</span> pivot_data.mean()</span>
<span id="cb26-25"><a href="#cb26-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-26"><a href="#cb26-26" aria-hidden="true" tabindex="-1"></a><span class="co"># Identify the largest-growth industry</span></span>
<span id="cb26-27"><a href="#cb26-27" aria-hidden="true" tabindex="-1"></a>largest_growth_industry <span class="op">=</span> industry_avg_growth.idxmax()</span>
<span id="cb26-28"><a href="#cb26-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-29"><a href="#cb26-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate the average of all other industries</span></span>
<span id="cb26-30"><a href="#cb26-30" aria-hidden="true" tabindex="-1"></a>other_industries_avg <span class="op">=</span> pivot_data.drop(columns<span class="op">=</span>largest_growth_industry).mean(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb26-31"><a href="#cb26-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-32"><a href="#cb26-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the largest-growth industry and the average of all other industries</span></span>
<span id="cb26-33"><a href="#cb26-33" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">15</span>, <span class="dv">8</span>))</span>
<span id="cb26-34"><a href="#cb26-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-35"><a href="#cb26-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the largest-growth industry</span></span>
<span id="cb26-36"><a href="#cb26-36" aria-hidden="true" tabindex="-1"></a>plt.plot(pivot_data.index, pivot_data[largest_growth_industry], label<span class="op">=</span><span class="ss">f&quot;Largest Growth Industry: </span><span class="sc">{</span>largest_growth_industry<span class="sc">}</span><span class="ss">&quot;</span>, alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb26-37"><a href="#cb26-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-38"><a href="#cb26-38" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the average of all other industries</span></span>
<span id="cb26-39"><a href="#cb26-39" aria-hidden="true" tabindex="-1"></a>plt.plot(pivot_data.index, other_industries_avg, label<span class="op">=</span><span class="st">&quot;Average of Other Industries&quot;</span>, alpha<span class="op">=</span><span class="fl">0.8</span>)</span>
<span id="cb26-40"><a href="#cb26-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-41"><a href="#cb26-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Format the x-axis to show ticks for every year</span></span>
<span id="cb26-42"><a href="#cb26-42" aria-hidden="true" tabindex="-1"></a>plt.gca().xaxis.set_major_locator(mdates.YearLocator())  <span class="co"># Set major ticks at the start of each year</span></span>
<span id="cb26-43"><a href="#cb26-43" aria-hidden="true" tabindex="-1"></a>plt.gca().xaxis.set_major_formatter(mdates.DateFormatter(<span class="st">&#39;%Y&#39;</span>))  <span class="co"># Format ticks to show the year</span></span>
<span id="cb26-44"><a href="#cb26-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-45"><a href="#cb26-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Add labels and legend</span></span>
<span id="cb26-46"><a href="#cb26-46" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&#39;Largest Growth Industry vs. Average of Other Industries Over 5 Years&#39;</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb26-47"><a href="#cb26-47" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&#39;Year&#39;</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb26-48"><a href="#cb26-48" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&#39;Average Change&#39;</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb26-49"><a href="#cb26-49" aria-hidden="true" tabindex="-1"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb26-50"><a href="#cb26-50" aria-hidden="true" tabindex="-1"></a>plt.legend(title<span class="op">=</span><span class="st">&#39;Legend&#39;</span>, bbox_to_anchor<span class="op">=</span>(<span class="fl">1.05</span>, <span class="dv">1</span>), loc<span class="op">=</span><span class="st">&#39;upper left&#39;</span>, fontsize<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb26-51"><a href="#cb26-51" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb26-52"><a href="#cb26-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-53"><a href="#cb26-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Show the plot</span></span>
<span id="cb26-54"><a href="#cb26-54" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="output display_data">
<p><img
src="vertopal_3029dff3b32943149bfb6de06d795b6a/537b107f25a8d015ab93b4c087f9afa0d3f92624.png" /></p>
</div>
</div>
<section id="daily--change-analysis" class="cell markdown">
<h1>Daily % change analysis</h1>
<p>We will plot a histogram of daily price changes to see if theres any
patterns. Through this histogram, we see that for AAPL, its daily
returns are unimodal and mostly symmetrical. It slightly resembles a
normal distribution. We will pick a random stock, so lets see for Adobe
($ADBE)</p>
</section>
<div class="cell code" data-execution_count="17">
<div class="sourceCode" id="cb27"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>ticker <span class="op">=</span> <span class="st">&quot;ADBE&quot;</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>aapl_changes <span class="op">=</span> ratio_df[ratio_df[<span class="st">&quot;Ticker&quot;</span>] <span class="op">==</span> ticker][<span class="st">&quot;Change&quot;</span>]</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(ratio_df[ratio_df[<span class="st">&quot;Ticker&quot;</span>] <span class="op">==</span> ticker][<span class="st">&quot;Change&quot;</span>].mode())</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot the histogram</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>plt.hist(aapl_changes, bins<span class="op">=</span><span class="dv">30</span>, color<span class="op">=</span><span class="st">&#39;blue&#39;</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">&#39;black&#39;</span>)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="ss">f&quot;Histogram of &#39;Change&#39; for </span><span class="sc">{</span>ticker<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&quot;Change (%)&quot;</span>)</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&quot;Frequency&quot;</span>)</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>plt.grid(axis<span class="op">=</span><span class="st">&#39;y&#39;</span>, alpha<span class="op">=</span><span class="fl">0.75</span>)</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a></span></code></pre></div>
<div class="output stream stdout">
<pre><code>0    0.0
Name: Change, dtype: float64
</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_3029dff3b32943149bfb6de06d795b6a/fa153d0841bf82a879bc8ca8dfa3dcf51e2578aa.png" /></p>
</div>
</div>
<div class="cell markdown">
<p>This sort of looks like a normal distribution, but not good enough.
We can try to apply a smoothing technique by compounding returns over 30
days.</p>
<p>Now, we compound stock returns up to 30 days for each day and rebase
it to 1 so there are no negative values. Instead, negative returns are
represented as percentages in decimal (i.e. -10% = Close Price * 0.9)
This histogram looks more like a normal distribution and outliers are
not as far spaced apart - the data is more continuous.</p>
</div>
<div class="cell code" data-execution_count="18">
<div class="sourceCode" id="cb29"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>REBASE_DAYS <span class="op">=</span> <span class="dv">31</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="co"># this gets the growth but over 30 days and rebased to 1. </span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co"># there will not be any negatives and it is visibly smoother and looks more </span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="co"># normally distributed</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> getDataFrame(df):</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># CompoundedReturn is more important than Rebase, you can ignore Rebase for now</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;Rebase&#39;</span>] <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;Rebase&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Rebase&#39;</span>].astype(<span class="bu">float</span>)</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># compound percentages using cumprod</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># (1 + df[&#39;Change&#39;] / 100) converts day changes into a multiplication factor</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;Rebase&#39;</span>] <span class="op">=</span> <span class="dv">1</span> <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> df[<span class="st">&#39;Change&#39;</span>] <span class="op">/</span> <span class="dv">100</span>).cumprod()</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;CompoundedReturn&#39;</span>] <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> df[<span class="st">&#39;Change&#39;</span>] <span class="op">/</span> <span class="dv">100</span>).rolling(window<span class="op">=</span>REBASE_DAYS, min_periods<span class="op">=</span>REBASE_DAYS).<span class="bu">apply</span>(np.prod)</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;Rebase&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Rebase&#39;</span>].<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;Change&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Change&#39;</span>].<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;CompoundedReturn&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;CompoundedReturn&#39;</span>].<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># CompoundedReturn column shows the price change in relation to the past 30 days</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># this indicates when trends are overly bullish or bearish, </span></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># it also sort of follows a normal distribution</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> getDataFrame(ratio_df[ratio_df[<span class="st">&quot;Ticker&quot;</span>] <span class="op">==</span> ticker].copy())</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>plt.hist(df[<span class="st">&quot;CompoundedReturn&quot;</span>], bins<span class="op">=</span><span class="dv">20</span>, color<span class="op">=</span><span class="st">&#39;blue&#39;</span>, alpha<span class="op">=</span><span class="fl">0.7</span>, edgecolor<span class="op">=</span><span class="st">&#39;black&#39;</span>)</span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="ss">f&quot;Histogram of &#39;Change&#39; for </span><span class="sc">{</span>ticker<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&quot;30 Day Price Change (%) Rebased to 1&quot;</span>)</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&quot;Frequency&quot;</span>)</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>plt.grid(axis<span class="op">=</span><span class="st">&#39;y&#39;</span>, alpha<span class="op">=</span><span class="fl">0.75</span>)</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>plt.show()</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&quot;CompoundedReturn&quot;</span>].describe()</span></code></pre></div>
<div class="output display_data">
<p><img
src="vertopal_3029dff3b32943149bfb6de06d795b6a/8df9eb4dec6c38ab3a22f687da7326f30bde7325.png" /></p>
</div>
<div class="output execute_result" data-execution_count="18">
<pre><code>count    1480.000000
mean        1.045115
std         0.077437
min         0.770000
25%         0.990000
50%         1.050000
75%         1.100000
max         1.270000
Name: CompoundedReturn, dtype: float64</code></pre>
</div>
</div>
<div class="cell markdown">
<p>This looks a lot like a normal distribution! Although not all stock
returns are normally distributed, they are many cases where it does
appear to be so, especially after smoothing. You can read more about
this concept here: <a
href="https://www.investopedia.com/articles/investing/100714/using-normal-distribution-formula-optimize-your-portfolio.asp">https://www.investopedia.com/articles/investing/100714/using-normal-distribution-formula-optimize-your-portfolio.asp</a></p>
<p>We will use this feature later in our ML experiment.</p>
</div>
<section id="risk-adjusted-returns-by-industry" class="cell markdown">
<h1>Risk adjusted returns by industry</h1>
<p>Let's take a look at returns on a risk-adjusted basis now. In this
section, we look at the annualized Sharpe ratio, rolling Sharpe ratios
across mutliple years, and max drawdown vs average returns for different
industries.</p>
</section>
<div class="cell markdown">
<p>The Sharpe ratio compares the expected return of an asset to how
risky it is. By calculating the Sharpes of different industries, we can
get a better look into which ones will provide better returns on a risk
adjusted basis. It's calculated by the below formula. <img
src="vertopal_3029dff3b32943149bfb6de06d795b6a/image.png"
alt="image.png" /></p>
</div>
<div class="cell code" data-execution_count="30">
<div class="sourceCode" id="cb31"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>risk_free_rate <span class="op">=</span> <span class="fl">0.02</span>  </span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="co">#calculate Sharpe Ratio and Max Drawdown</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_metrics(df):</span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    results <span class="op">=</span> []</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> industry <span class="kw">in</span> df[<span class="st">&quot;Industry&quot;</span>].unique():</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>        industry_data <span class="op">=</span> df[df[<span class="st">&quot;Industry&quot;</span>] <span class="op">==</span> industry].copy()</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>        industry_data[<span class="st">&quot;Daily_Return&quot;</span>] <span class="op">=</span> industry_data[<span class="st">&quot;Change&quot;</span>] <span class="op">/</span> <span class="dv">100</span></span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>        industry_data[<span class="st">&quot;Excess_Return&quot;</span>] <span class="op">=</span> industry_data[<span class="st">&quot;Daily_Return&quot;</span>] <span class="op">-</span> risk_free_rate <span class="op">/</span> <span class="dv">252</span></span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Sharpe Ratio</span></span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>        sharpe_ratio <span class="op">=</span> (industry_data[<span class="st">&quot;Excess_Return&quot;</span>].mean() <span class="op">/</span> </span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>                        industry_data[<span class="st">&quot;Excess_Return&quot;</span>].std()) <span class="op">*</span> np.sqrt(<span class="dv">252</span>)</span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Max Drawdown</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>        cumulative_returns <span class="op">=</span> (<span class="dv">1</span> <span class="op">+</span> industry_data[<span class="st">&quot;Daily_Return&quot;</span>]).cumprod()</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>        peak <span class="op">=</span> cumulative_returns.cummax()</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>        max_drawdown <span class="op">=</span> ((cumulative_returns <span class="op">-</span> peak) <span class="op">/</span> peak).<span class="bu">min</span>()</span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>        results.append({</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;Industry&quot;</span>: industry,</span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;Sharpe Ratio&quot;</span>: sharpe_ratio,</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;Max Drawdown&quot;</span>: <span class="bu">abs</span>(max_drawdown),</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;Average Return&quot;</span>: industry_data[<span class="st">&quot;Excess_Return&quot;</span>].mean() <span class="op">*</span> <span class="dv">252</span></span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(results)</span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>metrics_df <span class="op">=</span> calculate_metrics(ratio_df)</span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>sharpe_df <span class="op">=</span> metrics_df.sort_values(<span class="st">&quot;Sharpe Ratio&quot;</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>plt.barh(sharpe_df[<span class="st">&quot;Industry&quot;</span>], sharpe_df[<span class="st">&quot;Sharpe Ratio&quot;</span>], color<span class="op">=</span><span class="st">&#39;skyblue&#39;</span>)</span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&quot;Sharpe Ratio&quot;</span>)</span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&quot;Annualized Sharpe Ratio by Industry&quot;</span>)</span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a>plt.grid(axis<span class="op">=</span><span class="st">&#39;x&#39;</span>)</span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="output display_data">
<p><img
src="vertopal_3029dff3b32943149bfb6de06d795b6a/127f295a8b34df4c1b1cbf9bdf8af355a1ded8ae.png" /></p>
</div>
</div>
<div class="cell markdown">
<p>Max drawdown shows how great the downside potential is. By comparing
it to the average return, we can get an idea of the trade off between
potential losses and gains for different industries</p>
</div>
<div class="cell code">
<div class="sourceCode" id="cb32"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">6</span>))</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>plt.scatter(metrics_df[<span class="st">&quot;Average Return&quot;</span>], metrics_df[<span class="st">&quot;Max Drawdown&quot;</span>], color<span class="op">=</span><span class="st">&#39;skyblue&#39;</span>, alpha<span class="op">=</span><span class="fl">0.7</span>)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, row <span class="kw">in</span> metrics_df.iterrows():</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>    plt.annotate(row[<span class="st">&quot;Industry&quot;</span>], (row[<span class="st">&quot;Average Return&quot;</span>], row[<span class="st">&quot;Max Drawdown&quot;</span>]), fontsize<span class="op">=</span><span class="dv">8</span>, ha<span class="op">=</span><span class="st">&#39;right&#39;</span>)</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">&quot;Average Return&quot;</span>)</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">&quot;Max Drawdown&quot;</span>)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&quot;Max Drawdown vs. Average Return by Industry&quot;</span>)</span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>plt.grid()</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="output stream stderr">
<pre><code>C:\Users\zhong\AppData\Local\Temp\ipykernel_39320\1172181919.py:8: UserWarning: No artists with labels found to put in legend.  Note that artists whose label start with an underscore are ignored when legend() is called with no argument.
  plt.legend()
</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_3029dff3b32943149bfb6de06d795b6a/18c4e85171304118e79f6a9ee1a5e68592e7faab.png" /></p>
</div>
</div>
<div class="cell markdown">
<p>Another way that we can visualize the Sharpe is with a rolling Sharpe
ratio, which shows how the Sharpe changes over time. Let's only look at
a single year for now, as it get's a little crazy to look at longer time
periods all at once.</p>
</div>
<div class="cell code" data-execution_count="34">
<div class="sourceCode" id="cb34"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Rolling Sharpe Ratio</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_rolling_sharpe(rolling_sharpe_results, start, end):</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> industry, rolling_sharpe <span class="kw">in</span> rolling_sharpe_results.items():</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>        period_data <span class="op">=</span> rolling_sharpe[(rolling_sharpe.index <span class="op">&gt;=</span> start) <span class="op">&amp;</span> (rolling_sharpe.index <span class="op">&lt;</span> end)]</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> period_data.empty:</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>            plt.plot(period_data.index, period_data.values, label<span class="op">=</span>industry, alpha<span class="op">=</span><span class="fl">0.8</span>, linewidth<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="ss">f&quot;Rolling Sharpe Ratios (</span><span class="sc">{</span>start<span class="sc">.</span>year<span class="sc">}</span><span class="ss">-</span><span class="sc">{</span>end<span class="sc">.</span>year<span class="sc">}</span><span class="ss">)&quot;</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">&quot;Date&quot;</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">&quot;Rolling Sharpe Ratio&quot;</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>    plt.legend(title<span class="op">=</span><span class="st">&quot;Industries&quot;</span>, bbox_to_anchor<span class="op">=</span>(<span class="fl">1.05</span>, <span class="dv">1</span>), loc<span class="op">=</span><span class="st">&#39;upper left&#39;</span>, fontsize<span class="op">=</span><span class="dv">9</span>)</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>    plt.grid()</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> compute_rolling_sharpe(df, window<span class="op">=</span><span class="dv">252</span>):</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>    rolling_sharpe_results <span class="op">=</span> {}</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> industry <span class="kw">in</span> df[<span class="st">&quot;Industry&quot;</span>].unique():</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>        industry_data <span class="op">=</span> df[df[<span class="st">&quot;Industry&quot;</span>] <span class="op">==</span> industry].copy()</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>        industry_data[<span class="st">&quot;Date&quot;</span>] <span class="op">=</span> pd.to_datetime(industry_data[<span class="st">&quot;Date&quot;</span>])</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>        industry_data.set_index(<span class="st">&quot;Date&quot;</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>        industry_data.sort_index(inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>        industry_data[<span class="st">&quot;Daily_Return&quot;</span>] <span class="op">=</span> industry_data[<span class="st">&quot;Change&quot;</span>] <span class="op">/</span> <span class="dv">100</span></span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>        industry_data[<span class="st">&quot;Excess_Return&quot;</span>] <span class="op">=</span> industry_data[<span class="st">&quot;Daily_Return&quot;</span>] <span class="op">-</span> risk_free_rate <span class="op">/</span> <span class="dv">252</span></span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>        rolling_sharpe <span class="op">=</span> (industry_data[<span class="st">&quot;Excess_Return&quot;</span>]</span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>                          .rolling(window<span class="op">=</span>window, min_periods<span class="op">=</span><span class="dv">10</span>) </span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>                          .mean()) <span class="op">/</span> (industry_data[<span class="st">&quot;Excess_Return&quot;</span>]</span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>                          .rolling(window<span class="op">=</span>window, min_periods<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a>                          .std()) <span class="op">*</span> np.sqrt(<span class="dv">252</span>)</span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a>        rolling_sharpe.dropna(inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> rolling_sharpe.empty:</span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a>            <span class="cf">continue</span> </span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a>        rolling_sharpe_results[industry] <span class="op">=</span> rolling_sharpe</span>
<span id="cb34-42"><a href="#cb34-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-43"><a href="#cb34-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> rolling_sharpe_results</span>
<span id="cb34-44"><a href="#cb34-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-45"><a href="#cb34-45" aria-hidden="true" tabindex="-1"></a>rolling_sharpe_results <span class="op">=</span> compute_rolling_sharpe(ratio_df)</span>
<span id="cb34-46"><a href="#cb34-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-47"><a href="#cb34-47" aria-hidden="true" tabindex="-1"></a><span class="co"># Let&#39;s only do one year </span></span>
<span id="cb34-48"><a href="#cb34-48" aria-hidden="true" tabindex="-1"></a>start_date <span class="op">=</span> pd.Timestamp(<span class="st">&#39;2019-01-01&#39;</span>)</span>
<span id="cb34-49"><a href="#cb34-49" aria-hidden="true" tabindex="-1"></a>end_date <span class="op">=</span> pd.Timestamp(<span class="st">&#39;2020-12-31&#39;</span>)</span>
<span id="cb34-50"><a href="#cb34-50" aria-hidden="true" tabindex="-1"></a>plot_rolling_sharpe(rolling_sharpe_results, start_date, end_date)</span></code></pre></div>
<div class="output display_data">
<p><img
src="vertopal_3029dff3b32943149bfb6de06d795b6a/49cd9cd824fd7301bafe3541eb3c06ac279a0913.png" /></p>
</div>
</div>
<div class="cell markdown">
<p>We can see that some industries fluctuate their Sharpe ratio much
more than others, which means that they're less stable investments.
Returns on investment are less stable, and potentially more subjective
to changes in market condition.</p>
</div>
<section id="part-3-ml" class="cell markdown">
<h1>Part 3: ML</h1>
</section>
<div class="cell code" data-execution_count="20">
<div class="sourceCode" id="cb35"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas_ta <span class="im">as</span> ta</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="co"># leave out the open, high, low - can just pick close</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> df[[<span class="st">&#39;Ticker&#39;</span>, <span class="st">&#39;Date&#39;</span>,<span class="st">&#39;Close&#39;</span>, <span class="st">&#39;Volume&#39;</span>, <span class="st">&#39;CompoundedReturn&#39;</span>]].copy()</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">&#39;display.max_rows&#39;</span>, <span class="dv">20</span>)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>df.ta.rsi(append<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a><span class="co"># df.ta.macd(append=True)</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>df.ta.hma(append<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>df.ta.ema(append<span class="op">=</span><span class="va">True</span>, length<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>df.ta.ema(append<span class="op">=</span><span class="va">True</span>, length<span class="op">=</span><span class="dv">30</span>)</span></code></pre></div>
<div class="output execute_result" data-execution_count="20">
<pre><code>31545           NaN
31546           NaN
31547           NaN
31548           NaN
31549           NaN
            ...    
33050    476.833032
33051    477.023159
33052    477.764245
33053    478.510423
33054    479.279428
Name: EMA_30, Length: 1510, dtype: float64</code></pre>
</div>
</div>
<div class="cell code" data-execution_count="21">
<div class="sourceCode" id="cb37"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># stock volume can be skewed so we need to transform it</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&quot;Volume&quot;</span>] <span class="op">=</span> np.log1p(df[<span class="st">&quot;Volume&quot;</span>])</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="co"># compounded return is normal so lets standardize it</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&quot;CompoundedReturn&quot;</span>] <span class="op">=</span> (df[<span class="st">&quot;CompoundedReturn&quot;</span>] <span class="op">-</span> df[<span class="st">&quot;CompoundedReturn&quot;</span>].mean())<span class="op">/</span> df[<span class="st">&quot;CompoundedReturn&quot;</span>].std()</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&quot;CompoundedReturn&quot;</span>]</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="co"># normalize stock prices - this will mean indicators based on price will also need to be normalized</span></span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>close_min <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>].<span class="bu">min</span>()</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>close_max <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>].<span class="bu">max</span>()</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&quot;Close&quot;</span>] <span class="op">=</span> (df[<span class="st">&quot;Close&quot;</span>] <span class="op">-</span> close_min) <span class="op">/</span> (close_max <span class="op">-</span> close_min)</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&quot;HMA_10&quot;</span>] <span class="op">=</span> (df[<span class="st">&quot;HMA_10&quot;</span>] <span class="op">-</span> close_min) <span class="op">/</span> (close_max <span class="op">-</span> close_min)</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&quot;EMA_10&quot;</span>] <span class="op">=</span> (df[<span class="st">&quot;EMA_10&quot;</span>] <span class="op">-</span> close_min) <span class="op">/</span> (close_max <span class="op">-</span> close_min)</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&quot;EMA_30&quot;</span>] <span class="op">=</span> (df[<span class="st">&quot;EMA_30&quot;</span>] <span class="op">-</span> close_min) <span class="op">/</span> (close_max <span class="op">-</span> close_min)</span></code></pre></div>
</div>
<div class="cell code" data-execution_count="22">
<div class="sourceCode" id="cb38"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Phase idea source: ThinkOrSwim</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> phase():</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    conditions <span class="op">=</span> [</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>        (df[<span class="st">&#39;Close&#39;</span>] <span class="op">&lt;</span> df[<span class="st">&#39;EMA_10&#39;</span>]) <span class="op">&amp;</span> (df[<span class="st">&#39;Close&#39;</span>] <span class="op">&lt;</span> df[<span class="st">&#39;EMA_30&#39;</span>]),  <span class="co"># Phase 1 - stock has broken horizontal support and we&#39;re waiting for it to find support and enter trend reversal</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>        (df[<span class="st">&#39;Close&#39;</span>] <span class="op">&gt;</span> df[<span class="st">&#39;EMA_10&#39;</span>]) <span class="op">&amp;</span> (df[<span class="st">&#39;Close&#39;</span>] <span class="op">&lt;</span> df[<span class="st">&#39;EMA_30&#39;</span>]),  <span class="co"># Phase 2 - stock breaking upward, chaning from downtrend to uptrend</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>        ( ((df[<span class="st">&#39;Close&#39;</span>] <span class="op">&gt;</span> df[<span class="st">&#39;EMA_10&#39;</span>]) <span class="op">&amp;</span> (df[<span class="st">&#39;Close&#39;</span>] <span class="op">&gt;</span> df[<span class="st">&#39;EMA_30&#39;</span>])) <span class="op">&amp;</span> (df[<span class="st">&#39;EMA_10&#39;</span>] <span class="op">&gt;</span> df[<span class="st">&#39;EMA_30&#39;</span>]) <span class="op">&amp;</span> (df[<span class="st">&#39;FallingHull&#39;</span>] <span class="op">==</span> <span class="dv">1</span> )),   <span class="co"># Phase 4 - still in #3 but showing resistance - warning sign or bullish entry opportunity</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>        (df[<span class="st">&#39;Close&#39;</span>] <span class="op">&gt;</span> df[<span class="st">&#39;EMA_10&#39;</span>]) <span class="op">&amp;</span> (df[<span class="st">&#39;Close&#39;</span>] <span class="op">&gt;</span> df[<span class="st">&#39;EMA_30&#39;</span>]),  <span class="co"># Phase 3 - strong trending stock</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>        (df[<span class="st">&#39;Close&#39;</span>] <span class="op">&lt;</span> df[<span class="st">&#39;EMA_10&#39;</span>]) <span class="op">&amp;</span> (df[<span class="st">&#39;Close&#39;</span>] <span class="op">&gt;</span> df[<span class="st">&#39;EMA_30&#39;</span>])   <span class="co"># Phase 5 - strong trending stock having brief pullback</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    phase_values <span class="op">=</span> [<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">3</span>, <span class="dv">5</span>]</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&#39;Phase&#39;</span>] <span class="op">=</span> np.select(conditions, phase_values, default<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Idea source / learn more here: https://machinelearning-basics.com/hma-in-python-hull-moving-average/</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>df[<span class="st">&#39;FallingHull&#39;</span>] <span class="op">=</span> (df[<span class="st">&#39;HMA_10&#39;</span>] <span class="op">&lt;=</span> df[<span class="st">&#39;HMA_10&#39;</span>].shift(<span class="dv">1</span>)).astype(<span class="bu">int</span>)</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>phase()</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>df.dropna(inplace<span class="op">=</span><span class="va">True</span>)</span></code></pre></div>
</div>
<section id="signal-prediction-a-simple-approach" class="cell markdown">
<h3>Signal Prediction: a simple approach</h3>
<p>ML models typically have an noise overfitting problem with stock
market data, so we will first try to train a simple LogisticRegression
model on the data to classify days as a day to buy or not (0 for no buy,
1 for buy). We need to specify the number of days to look ahead. We can
tune this value later to find the optimal days to wait after buying.</p>
<p>Short term price movements are very chaotic and can change day-to-day
due to many factors not related to the current price. Therefore, we can
judge our ML model based on its accuracy being better than 0.5 (better
than just flipping a coin that the next day will be higher or lower than
today).</p>
</section>
<div class="cell code" data-execution_count="23">
<div class="sourceCode" id="cb39"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> TimeSeriesSplit</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LogisticRegression</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> accuracy_score</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_model_accuracy():</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    timeseries <span class="op">=</span> TimeSeriesSplit(n_splits<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>    accuracies <span class="op">=</span> []</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, (train_index, test_index) <span class="kw">in</span> <span class="bu">enumerate</span>(timeseries.split(X)):</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>        X_train<span class="op">=</span> X.iloc[train_index]</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>        X_test <span class="op">=</span> X.iloc[test_index]</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>        y_train <span class="op">=</span> y.iloc[train_index]</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>        y_test <span class="op">=</span> y.iloc[test_index]</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>        <span class="co"># want to predict class so cant use linear regression</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>        model <span class="op">=</span> LogisticRegression(random_state<span class="op">=</span><span class="dv">42</span>, max_iter<span class="op">=</span><span class="dv">500</span>)</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>        model.fit(X_train, y_train)</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>        y_pred <span class="op">=</span> model.predict(X_test)</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>        accuracies.append(accuracy_score(y_test, y_pred))</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (np.mean(accuracies))</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>trials <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>TARGET_DAYS_AHEAD <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>,<span class="dv">20</span>):</span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Hyperparameters</span></span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&quot;FutureReturn&quot;</span>] <span class="op">=</span> df[<span class="st">&quot;Close&quot;</span>].shift(<span class="op">-</span>TARGET_DAYS_AHEAD) <span class="op">/</span> df[<span class="st">&quot;Close&quot;</span>] <span class="op">-</span> <span class="dv">1</span></span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">&quot;BuySignal&quot;</span>] <span class="op">=</span> np.where(df[<span class="st">&quot;FutureReturn&quot;</span>] <span class="op">&gt;</span> <span class="dv">0</span>, <span class="dv">1</span>, <span class="dv">0</span>)</span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a>    df.dropna(inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">#print(df[&quot;BuySignal&quot;].value_counts())</span></span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> df[[<span class="st">&#39;Close&#39;</span>, <span class="st">&#39;Volume&#39;</span>, <span class="st">&#39;CompoundedReturn&#39;</span>, <span class="st">&#39;RSI_14&#39;</span>, <span class="st">&#39;FallingHull&#39;</span>, <span class="st">&quot;Phase&quot;</span>]]</span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> df[<span class="st">&#39;BuySignal&#39;</span>]</span>
<span id="cb39-37"><a href="#cb39-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-38"><a href="#cb39-38" aria-hidden="true" tabindex="-1"></a>    accuracies <span class="op">=</span> []</span>
<span id="cb39-39"><a href="#cb39-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(trials):</span>
<span id="cb39-40"><a href="#cb39-40" aria-hidden="true" tabindex="-1"></a>        accuracies.append(get_model_accuracy())</span>
<span id="cb39-41"><a href="#cb39-41" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;Mean accuracy when TARGET_DAYS_AHEAD = </span><span class="sc">{</span>TARGET_DAYS_AHEAD<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>np<span class="sc">.</span>mean(accuracies)<span class="sc">}</span><span class="ss">&quot;</span>)</span>
<span id="cb39-42"><a href="#cb39-42" aria-hidden="true" tabindex="-1"></a>    TARGET_DAYS_AHEAD <span class="op">=</span> TARGET_DAYS_AHEAD <span class="op">+</span> <span class="dv">1</span></span>
<span id="cb39-43"><a href="#cb39-43" aria-hidden="true" tabindex="-1"></a>    </span></code></pre></div>
<div class="output stream stdout">
<pre><code>Mean accuracy when TARGET_DAYS_AHEAD = 1: 0.5308943089430895
Mean accuracy when TARGET_DAYS_AHEAD = 2: 0.5447154471544715
Mean accuracy when TARGET_DAYS_AHEAD = 3: 0.5363265306122449
Mean accuracy when TARGET_DAYS_AHEAD = 4: 0.5477551020408163
Mean accuracy when TARGET_DAYS_AHEAD = 5: 0.5844262295081968
Mean accuracy when TARGET_DAYS_AHEAD = 6: 0.5604938271604938
Mean accuracy when TARGET_DAYS_AHEAD = 7: 0.552892561983471
Mean accuracy when TARGET_DAYS_AHEAD = 8: 0.5908333333333334
Mean accuracy when TARGET_DAYS_AHEAD = 9: 0.594142259414226
Mean accuracy when TARGET_DAYS_AHEAD = 10: 0.5856540084388187
Mean accuracy when TARGET_DAYS_AHEAD = 11: 0.5999999999999999
Mean accuracy when TARGET_DAYS_AHEAD = 12: 0.6017167381974249
Mean accuracy when TARGET_DAYS_AHEAD = 13: 0.5844155844155845
Mean accuracy when TARGET_DAYS_AHEAD = 14: 0.5781659388646287
Mean accuracy when TARGET_DAYS_AHEAD = 15: 0.5743362831858406
Mean accuracy when TARGET_DAYS_AHEAD = 16: 0.5687499999999999
Mean accuracy when TARGET_DAYS_AHEAD = 17: 0.6027149321266967
Mean accuracy when TARGET_DAYS_AHEAD = 18: 0.6027522935779818
Mean accuracy when TARGET_DAYS_AHEAD = 19: 0.5981395348837208
</code></pre>
</div>
</div>
<div class="cell markdown">
<p>Notice that as TARGET_DAYS_AHEAD increases, accuracy tends to
increase. Since we are picking stocks from the S&amp;P500, which are the
best 500 companies in the US stock market, it could make prices biased
towards positive gains. As we can see, the accuracy ranges from around
0.53 to 0.6 depending on the number of days our labels are looking
ahead. This supervised learning approach using Logistic Regression is a
good start, but lets see if it can be improved with a more complicated
approach.</p>
</div>
<section
id="lstm-stock-change-forecasting---jupyter-notebook-with-multivariate-attention-ensemble"
class="cell markdown">
<h2>LSTM Stock Change Forecasting - Jupyter Notebook (with Multivariate
Attention Ensemble)</h2>
<p>This section of ML part implements a Long Short-Term Memory (LSTM)
model for stock price prediction using PyTorch. The goal is to predict
whether a given stock will increase or decrease in price over a
specified number of days. Therefore, the model is essentially a binary
classifier. However, since we are working with historical financial
data, we need to consider the time series nature of the data. The LSTM
model is well-suited for this task as it can learn from sequences of
data and capture temporal dependencies. The addition of attention
mechanisms allows the model to focus on relevant parts of the input
sequence, improving its performance in predicting stock price movements.
Therefore, the attention should directly help with the temporal
dependencies of the data.</p>
<p>The final result will display the accuracy of the model on the test
data, as well as the F1 score and ROC AUC score.</p>
</section>
<div class="cell code" data-execution_count="24">
<div class="sourceCode" id="cb41"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch <span class="im">import</span> nn, optim</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> Dataset, DataLoader, random_split</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> accuracy_score, f1_score, roc_auc_score</span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Config ---</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>SEQ_LEN <span class="op">=</span> <span class="dv">30</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>FORECAST_HORIZON <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>BATCH_SIZE <span class="op">=</span> <span class="dv">32</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>EPOCHS <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>LR <span class="op">=</span> <span class="fl">0.0005</span></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>TRAIN_SPLIT <span class="op">=</span> <span class="fl">0.8</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Device ---</span></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a><span class="co"># If anyone has access to a NVIDIA CUDA GPU, its much faster than CPU</span></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>device <span class="op">=</span> torch.device(<span class="st">&quot;cuda&quot;</span> <span class="cf">if</span> torch.cuda.is_available() <span class="cf">else</span> <span class="st">&quot;cpu&quot;</span>)</span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Focal Loss ---</span></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FocalLoss(nn.Module):</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, gamma<span class="op">=</span><span class="dv">2</span>):</span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.gamma <span class="op">=</span> gamma</span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.bce <span class="op">=</span> nn.BCEWithLogitsLoss(reduction<span class="op">=</span><span class="st">&#39;none&#39;</span>)</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, inputs, targets):</span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>        bce_loss <span class="op">=</span> <span class="va">self</span>.bce(inputs, targets)</span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>        pt <span class="op">=</span> torch.exp(<span class="op">-</span>bce_loss)</span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> ((<span class="dv">1</span> <span class="op">-</span> pt) <span class="op">**</span> <span class="va">self</span>.gamma <span class="op">*</span> bce_loss).mean()</span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Dataset Class ---</span></span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> smooth_targets(y, smoothing<span class="op">=</span><span class="fl">0.1</span>):</span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> y <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> smoothing) <span class="op">+</span> <span class="fl">0.5</span> <span class="op">*</span> smoothing</span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> StockDirectionDataset(Dataset):</span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, df, forecast_horizon<span class="op">=</span><span class="dv">1</span>, tickers_subset<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.data <span class="op">=</span> []</span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> df.copy()</span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> tickers_subset <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a>            df <span class="op">=</span> df[df[<span class="st">&#39;Ticker&#39;</span>].isin(<span class="bu">list</span>(tickers_subset))]</span>
<span id="cb41-44"><a href="#cb41-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-45"><a href="#cb41-45" aria-hidden="true" tabindex="-1"></a>        display(df.head(<span class="dv">5</span>))</span>
<span id="cb41-46"><a href="#cb41-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-47"><a href="#cb41-47" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">&#39;Prev_Close&#39;</span>] <span class="op">=</span> df.groupby(<span class="st">&#39;Ticker&#39;</span>)[<span class="st">&#39;Close&#39;</span>].shift(<span class="dv">1</span>)</span>
<span id="cb41-48"><a href="#cb41-48" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">&#39;LogReturn&#39;</span>] <span class="op">=</span> np.log(df[<span class="st">&#39;Close&#39;</span>] <span class="op">/</span> df[<span class="st">&#39;Prev_Close&#39;</span>])</span>
<span id="cb41-49"><a href="#cb41-49" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">&#39;Momentum&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>] <span class="op">-</span> df[<span class="st">&#39;Close&#39;</span>].shift(<span class="dv">10</span>)</span>
<span id="cb41-50"><a href="#cb41-50" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">&#39;Target&#39;</span>] <span class="op">=</span> (df.groupby(<span class="st">&#39;Ticker&#39;</span>)[<span class="st">&#39;Close&#39;</span>].shift(<span class="op">-</span>forecast_horizon) <span class="op">&gt;</span> df[<span class="st">&#39;Close&#39;</span>]).astype(<span class="bu">int</span>)</span>
<span id="cb41-51"><a href="#cb41-51" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">&#39;RollingMean_5&#39;</span>] <span class="op">=</span> df.groupby(<span class="st">&#39;Ticker&#39;</span>)[<span class="st">&#39;Close&#39;</span>].transform(<span class="kw">lambda</span> x: x.rolling(<span class="dv">5</span>).mean())</span>
<span id="cb41-52"><a href="#cb41-52" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">&#39;RollingStd_5&#39;</span>] <span class="op">=</span> df.groupby(<span class="st">&#39;Ticker&#39;</span>)[<span class="st">&#39;Close&#39;</span>].transform(<span class="kw">lambda</span> x: x.rolling(<span class="dv">5</span>).std())</span>
<span id="cb41-53"><a href="#cb41-53" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">&#39;VolatilityRatio&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;RollingStd_5&#39;</span>] <span class="op">/</span> df[<span class="st">&#39;RollingMean_5&#39;</span>]</span>
<span id="cb41-54"><a href="#cb41-54" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">&#39;PriceAboveEMA&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Close&#39;</span>] <span class="op">-</span> df[<span class="st">&#39;EMA_10&#39;</span>]</span>
<span id="cb41-55"><a href="#cb41-55" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">&#39;Volume_Change&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Volume&#39;</span>].pct_change()</span>
<span id="cb41-56"><a href="#cb41-56" aria-hidden="true" tabindex="-1"></a>        df[<span class="st">&#39;Volume_MA_5&#39;</span>] <span class="op">=</span> df[<span class="st">&#39;Volume&#39;</span>].rolling(<span class="dv">5</span>).mean()</span>
<span id="cb41-57"><a href="#cb41-57" aria-hidden="true" tabindex="-1"></a>        <span class="co"># df[&#39;High_Low_Spread&#39;] = df[&#39;High&#39;] - df[&#39;Low&#39;]</span></span>
<span id="cb41-58"><a href="#cb41-58" aria-hidden="true" tabindex="-1"></a>        <span class="co"># df[&#39;Close_Open_Spread&#39;] = df[&#39;Close&#39;] - df[&#39;Open&#39;]</span></span>
<span id="cb41-59"><a href="#cb41-59" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> df.dropna()</span>
<span id="cb41-60"><a href="#cb41-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-61"><a href="#cb41-61" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.scaler_x <span class="op">=</span> StandardScaler()</span>
<span id="cb41-62"><a href="#cb41-62" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.features <span class="op">=</span> [col <span class="cf">for</span> col <span class="kw">in</span> df.columns <span class="cf">if</span> col <span class="kw">not</span> <span class="kw">in</span> [<span class="st">&#39;Ticker&#39;</span>, <span class="st">&#39;Date&#39;</span>, <span class="st">&#39;Target&#39;</span>, <span class="st">&#39;Close&#39;</span>]]</span>
<span id="cb41-63"><a href="#cb41-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-64"><a href="#cb41-64" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> ticker <span class="kw">in</span> df[<span class="st">&#39;Ticker&#39;</span>].unique():</span>
<span id="cb41-65"><a href="#cb41-65" aria-hidden="true" tabindex="-1"></a>            group <span class="op">=</span> df[df[<span class="st">&#39;Ticker&#39;</span>] <span class="op">==</span> ticker].sort_values(<span class="st">&#39;Date&#39;</span>).reset_index(drop<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb41-66"><a href="#cb41-66" aria-hidden="true" tabindex="-1"></a>            group <span class="op">=</span> group.dropna()</span>
<span id="cb41-67"><a href="#cb41-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-68"><a href="#cb41-68" aria-hidden="true" tabindex="-1"></a>            X_all <span class="op">=</span> <span class="va">self</span>.scaler_x.fit_transform(group[<span class="va">self</span>.features])</span>
<span id="cb41-69"><a href="#cb41-69" aria-hidden="true" tabindex="-1"></a>            y_all <span class="op">=</span> group[<span class="st">&#39;Target&#39;</span>].values</span>
<span id="cb41-70"><a href="#cb41-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-71"><a href="#cb41-71" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(group) <span class="op">-</span> SEQ_LEN <span class="op">-</span> forecast_horizon):</span>
<span id="cb41-72"><a href="#cb41-72" aria-hidden="true" tabindex="-1"></a>                x_seq <span class="op">=</span> X_all[i:i <span class="op">+</span> SEQ_LEN]</span>
<span id="cb41-73"><a href="#cb41-73" aria-hidden="true" tabindex="-1"></a>                y_orig <span class="op">=</span> y_all[i <span class="op">+</span> SEQ_LEN <span class="op">+</span> forecast_horizon <span class="op">-</span> <span class="dv">1</span>]</span>
<span id="cb41-74"><a href="#cb41-74" aria-hidden="true" tabindex="-1"></a>                y_target <span class="op">=</span> smooth_targets(y_orig)</span>
<span id="cb41-75"><a href="#cb41-75" aria-hidden="true" tabindex="-1"></a>                <span class="va">self</span>.data.append((x_seq, y_target, y_orig))</span>
<span id="cb41-76"><a href="#cb41-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-77"><a href="#cb41-77" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__len__</span>(<span class="va">self</span>):</span>
<span id="cb41-78"><a href="#cb41-78" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">len</span>(<span class="va">self</span>.data)</span>
<span id="cb41-79"><a href="#cb41-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-80"><a href="#cb41-80" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__getitem__</span>(<span class="va">self</span>, idx):</span>
<span id="cb41-81"><a href="#cb41-81" aria-hidden="true" tabindex="-1"></a>        x, y_smoothed, y_orig <span class="op">=</span> <span class="va">self</span>.data[idx]</span>
<span id="cb41-82"><a href="#cb41-82" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> torch.tensor(x, dtype<span class="op">=</span>torch.float32), torch.tensor(y_smoothed, dtype<span class="op">=</span>torch.float32), torch.tensor(y_orig, dtype<span class="op">=</span>torch.int64)</span>
<span id="cb41-83"><a href="#cb41-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-84"><a href="#cb41-84" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Attention Module ---</span></span>
<span id="cb41-85"><a href="#cb41-85" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Attention(nn.Module):</span>
<span id="cb41-86"><a href="#cb41-86" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, input_dim):</span>
<span id="cb41-87"><a href="#cb41-87" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb41-88"><a href="#cb41-88" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.attn <span class="op">=</span> nn.Sequential(</span>
<span id="cb41-89"><a href="#cb41-89" aria-hidden="true" tabindex="-1"></a>            nn.Linear(input_dim, <span class="dv">64</span>),</span>
<span id="cb41-90"><a href="#cb41-90" aria-hidden="true" tabindex="-1"></a>            nn.Tanh(),</span>
<span id="cb41-91"><a href="#cb41-91" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="dv">64</span>, <span class="dv">1</span>)</span>
<span id="cb41-92"><a href="#cb41-92" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb41-93"><a href="#cb41-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-94"><a href="#cb41-94" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb41-95"><a href="#cb41-95" aria-hidden="true" tabindex="-1"></a>        scores <span class="op">=</span> <span class="va">self</span>.attn(x)</span>
<span id="cb41-96"><a href="#cb41-96" aria-hidden="true" tabindex="-1"></a>        weights <span class="op">=</span> torch.softmax(scores, dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb41-97"><a href="#cb41-97" aria-hidden="true" tabindex="-1"></a>        context <span class="op">=</span> (weights <span class="op">*</span> x).<span class="bu">sum</span>(dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb41-98"><a href="#cb41-98" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> context</span>
<span id="cb41-99"><a href="#cb41-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-100"><a href="#cb41-100" aria-hidden="true" tabindex="-1"></a><span class="co"># --- LSTM Classifier ---</span></span>
<span id="cb41-101"><a href="#cb41-101" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AttentionLSTMClassifier(nn.Module):</span>
<span id="cb41-102"><a href="#cb41-102" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, input_dim, hidden_dim<span class="op">=</span><span class="dv">128</span>, num_layers<span class="op">=</span><span class="dv">2</span>):</span>
<span id="cb41-103"><a href="#cb41-103" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>().<span class="fu">__init__</span>()</span>
<span id="cb41-104"><a href="#cb41-104" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.lstm <span class="op">=</span> nn.LSTM(input_dim, hidden_dim, num_layers, batch_first<span class="op">=</span><span class="va">True</span>, bidirectional<span class="op">=</span><span class="va">True</span>, dropout<span class="op">=</span><span class="fl">0.3</span>)</span>
<span id="cb41-105"><a href="#cb41-105" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.attn <span class="op">=</span> Attention(hidden_dim <span class="op">*</span> <span class="dv">2</span>)</span>
<span id="cb41-106"><a href="#cb41-106" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.ln <span class="op">=</span> nn.LayerNorm(hidden_dim <span class="op">*</span> <span class="dv">2</span>)</span>
<span id="cb41-107"><a href="#cb41-107" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.fc <span class="op">=</span> nn.Sequential(</span>
<span id="cb41-108"><a href="#cb41-108" aria-hidden="true" tabindex="-1"></a>            nn.Linear(hidden_dim <span class="op">*</span> <span class="dv">2</span>, <span class="dv">64</span>),</span>
<span id="cb41-109"><a href="#cb41-109" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb41-110"><a href="#cb41-110" aria-hidden="true" tabindex="-1"></a>            nn.Dropout(<span class="fl">0.2</span>),</span>
<span id="cb41-111"><a href="#cb41-111" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="dv">64</span>, <span class="dv">1</span>)</span>
<span id="cb41-112"><a href="#cb41-112" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb41-113"><a href="#cb41-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-114"><a href="#cb41-114" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb41-115"><a href="#cb41-115" aria-hidden="true" tabindex="-1"></a>        lstm_out, _ <span class="op">=</span> <span class="va">self</span>.lstm(x)</span>
<span id="cb41-116"><a href="#cb41-116" aria-hidden="true" tabindex="-1"></a>        context <span class="op">=</span> <span class="va">self</span>.attn(lstm_out)</span>
<span id="cb41-117"><a href="#cb41-117" aria-hidden="true" tabindex="-1"></a>        context <span class="op">=</span> <span class="va">self</span>.ln(context)</span>
<span id="cb41-118"><a href="#cb41-118" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.fc(context).squeeze(<span class="dv">1</span>)</span>
<span id="cb41-119"><a href="#cb41-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-120"><a href="#cb41-120" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Training Loop ---</span></span>
<span id="cb41-121"><a href="#cb41-121" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train_model(model, dataloader, optimizer, criterion, scheduler):</span>
<span id="cb41-122"><a href="#cb41-122" aria-hidden="true" tabindex="-1"></a>    model.train()</span>
<span id="cb41-123"><a href="#cb41-123" aria-hidden="true" tabindex="-1"></a>    best_loss <span class="op">=</span> <span class="bu">float</span>(<span class="st">&#39;inf&#39;</span>)</span>
<span id="cb41-124"><a href="#cb41-124" aria-hidden="true" tabindex="-1"></a>    patience <span class="op">=</span> <span class="dv">10</span></span>
<span id="cb41-125"><a href="#cb41-125" aria-hidden="true" tabindex="-1"></a>    trigger <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb41-126"><a href="#cb41-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-127"><a href="#cb41-127" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> epoch <span class="kw">in</span> <span class="bu">range</span>(EPOCHS):</span>
<span id="cb41-128"><a href="#cb41-128" aria-hidden="true" tabindex="-1"></a>        total_loss <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb41-129"><a href="#cb41-129" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> xb, yb, _ <span class="kw">in</span> dataloader:  <span class="co"># &lt;-- updated line</span></span>
<span id="cb41-130"><a href="#cb41-130" aria-hidden="true" tabindex="-1"></a>            xb, yb <span class="op">=</span> xb.to(device), yb.to(device)</span>
<span id="cb41-131"><a href="#cb41-131" aria-hidden="true" tabindex="-1"></a>            optimizer.zero_grad()</span>
<span id="cb41-132"><a href="#cb41-132" aria-hidden="true" tabindex="-1"></a>            preds <span class="op">=</span> model(xb)</span>
<span id="cb41-133"><a href="#cb41-133" aria-hidden="true" tabindex="-1"></a>            loss <span class="op">=</span> criterion(preds, yb)</span>
<span id="cb41-134"><a href="#cb41-134" aria-hidden="true" tabindex="-1"></a>            loss.backward()</span>
<span id="cb41-135"><a href="#cb41-135" aria-hidden="true" tabindex="-1"></a>            torch.nn.utils.clip_grad_norm_(model.parameters(), max_norm<span class="op">=</span><span class="fl">1.0</span>)</span>
<span id="cb41-136"><a href="#cb41-136" aria-hidden="true" tabindex="-1"></a>            optimizer.step()</span>
<span id="cb41-137"><a href="#cb41-137" aria-hidden="true" tabindex="-1"></a>            total_loss <span class="op">+=</span> loss.item()</span>
<span id="cb41-138"><a href="#cb41-138" aria-hidden="true" tabindex="-1"></a>        scheduler.step()</span>
<span id="cb41-139"><a href="#cb41-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-140"><a href="#cb41-140" aria-hidden="true" tabindex="-1"></a>        avg_loss <span class="op">=</span> total_loss <span class="op">/</span> <span class="bu">len</span>(dataloader)</span>
<span id="cb41-141"><a href="#cb41-141" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f&quot;Epoch </span><span class="sc">{</span>epoch<span class="op">+</span><span class="dv">1</span><span class="sc">}</span><span class="ss">/</span><span class="sc">{</span>EPOCHS<span class="sc">}</span><span class="ss">, Loss: </span><span class="sc">{</span>avg_loss<span class="sc">:.4f}</span><span class="ss">&quot;</span>)</span>
<span id="cb41-142"><a href="#cb41-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-143"><a href="#cb41-143" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> avg_loss <span class="op">&lt;</span> best_loss:</span>
<span id="cb41-144"><a href="#cb41-144" aria-hidden="true" tabindex="-1"></a>            best_loss <span class="op">=</span> avg_loss</span>
<span id="cb41-145"><a href="#cb41-145" aria-hidden="true" tabindex="-1"></a>            trigger <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb41-146"><a href="#cb41-146" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb41-147"><a href="#cb41-147" aria-hidden="true" tabindex="-1"></a>            trigger <span class="op">+=</span> <span class="dv">1</span></span>
<span id="cb41-148"><a href="#cb41-148" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> trigger <span class="op">&gt;=</span> patience:</span>
<span id="cb41-149"><a href="#cb41-149" aria-hidden="true" tabindex="-1"></a>                <span class="bu">print</span>(<span class="st">&quot;Early stopping&quot;</span>)</span>
<span id="cb41-150"><a href="#cb41-150" aria-hidden="true" tabindex="-1"></a>                <span class="cf">break</span></span>
<span id="cb41-151"><a href="#cb41-151" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-152"><a href="#cb41-152" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Evaluation ---</span></span>
<span id="cb41-153"><a href="#cb41-153" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> evaluate_model(model, dataloader):</span>
<span id="cb41-154"><a href="#cb41-154" aria-hidden="true" tabindex="-1"></a>    model.<span class="bu">eval</span>()</span>
<span id="cb41-155"><a href="#cb41-155" aria-hidden="true" tabindex="-1"></a>    all_preds, all_targets <span class="op">=</span> [], []</span>
<span id="cb41-156"><a href="#cb41-156" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> torch.no_grad():</span>
<span id="cb41-157"><a href="#cb41-157" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> xb, _, yb_orig <span class="kw">in</span> dataloader:</span>
<span id="cb41-158"><a href="#cb41-158" aria-hidden="true" tabindex="-1"></a>            preds <span class="op">=</span> torch.sigmoid(model(xb.to(device))).cpu().numpy()</span>
<span id="cb41-159"><a href="#cb41-159" aria-hidden="true" tabindex="-1"></a>            preds_binary <span class="op">=</span> np.array(preds <span class="op">&gt;</span> <span class="fl">0.5</span>).astype(<span class="bu">int</span>)</span>
<span id="cb41-160"><a href="#cb41-160" aria-hidden="true" tabindex="-1"></a>            all_preds.extend(preds_binary)</span>
<span id="cb41-161"><a href="#cb41-161" aria-hidden="true" tabindex="-1"></a>            all_targets.extend(yb_orig.numpy())</span>
<span id="cb41-162"><a href="#cb41-162" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-163"><a href="#cb41-163" aria-hidden="true" tabindex="-1"></a>    all_preds_binary <span class="op">=</span> np.array(all_preds).flatten()</span>
<span id="cb41-164"><a href="#cb41-164" aria-hidden="true" tabindex="-1"></a>    accuracy <span class="op">=</span> accuracy_score(all_targets, all_preds_binary)</span>
<span id="cb41-165"><a href="#cb41-165" aria-hidden="true" tabindex="-1"></a>    f1 <span class="op">=</span> f1_score(all_targets, all_preds_binary)</span>
<span id="cb41-166"><a href="#cb41-166" aria-hidden="true" tabindex="-1"></a>    roc_auc <span class="op">=</span> roc_auc_score(all_targets, all_preds_binary)</span>
<span id="cb41-167"><a href="#cb41-167" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-168"><a href="#cb41-168" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f&quot;Accuracy: </span><span class="sc">{</span>accuracy<span class="sc">:.4f}</span><span class="ss">, F1 Score: </span><span class="sc">{</span>f1<span class="sc">:.4f}</span><span class="ss">, ROC AUC: </span><span class="sc">{</span>roc_auc<span class="sc">:.4f}</span><span class="ss">&quot;</span>)</span>
<span id="cb41-169"><a href="#cb41-169" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> all_preds, all_targets</span>
<span id="cb41-170"><a href="#cb41-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-171"><a href="#cb41-171" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Load &amp; Train ---</span></span>
<span id="cb41-172"><a href="#cb41-172" aria-hidden="true" tabindex="-1"></a>tickers_subset <span class="op">=</span> df[<span class="st">&#39;Ticker&#39;</span>].unique()</span>
<span id="cb41-173"><a href="#cb41-173" aria-hidden="true" tabindex="-1"></a>full_dataset <span class="op">=</span> StockDirectionDataset(df, forecast_horizon<span class="op">=</span>FORECAST_HORIZON, tickers_subset<span class="op">=</span>tickers_subset)</span>
<span id="cb41-174"><a href="#cb41-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-175"><a href="#cb41-175" aria-hidden="true" tabindex="-1"></a>train_size <span class="op">=</span> <span class="bu">int</span>(<span class="bu">len</span>(full_dataset) <span class="op">*</span> TRAIN_SPLIT)</span>
<span id="cb41-176"><a href="#cb41-176" aria-hidden="true" tabindex="-1"></a>train_dataset, test_dataset <span class="op">=</span> random_split(full_dataset, [train_size, <span class="bu">len</span>(full_dataset) <span class="op">-</span> train_size])</span>
<span id="cb41-177"><a href="#cb41-177" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-178"><a href="#cb41-178" aria-hidden="true" tabindex="-1"></a>train_loader <span class="op">=</span> DataLoader(train_dataset, batch_size<span class="op">=</span>BATCH_SIZE, shuffle<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb41-179"><a href="#cb41-179" aria-hidden="true" tabindex="-1"></a>test_loader <span class="op">=</span> DataLoader(test_dataset, batch_size<span class="op">=</span>BATCH_SIZE)</span>
<span id="cb41-180"><a href="#cb41-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-181"><a href="#cb41-181" aria-hidden="true" tabindex="-1"></a>input_dim <span class="op">=</span> train_dataset[<span class="dv">0</span>][<span class="dv">0</span>].shape[<span class="dv">1</span>]</span>
<span id="cb41-182"><a href="#cb41-182" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> AttentionLSTMClassifier(input_dim).to(device)</span>
<span id="cb41-183"><a href="#cb41-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-184"><a href="#cb41-184" aria-hidden="true" tabindex="-1"></a>criterion <span class="op">=</span> FocalLoss(gamma<span class="op">=</span><span class="dv">2</span>)</span>
<span id="cb41-185"><a href="#cb41-185" aria-hidden="true" tabindex="-1"></a>optimizer <span class="op">=</span> optim.Adam(model.parameters(), lr<span class="op">=</span>LR)</span>
<span id="cb41-186"><a href="#cb41-186" aria-hidden="true" tabindex="-1"></a>scheduler <span class="op">=</span> optim.lr_scheduler.StepLR(optimizer, step_size<span class="op">=</span><span class="dv">5</span>, gamma<span class="op">=</span><span class="fl">0.9</span>)</span>
<span id="cb41-187"><a href="#cb41-187" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-188"><a href="#cb41-188" aria-hidden="true" tabindex="-1"></a>train_model(model, train_loader, optimizer, criterion, scheduler)</span>
<span id="cb41-189"><a href="#cb41-189" aria-hidden="true" tabindex="-1"></a>preds, targets <span class="op">=</span> evaluate_model(model, test_loader)</span>
<span id="cb41-190"><a href="#cb41-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-191"><a href="#cb41-191" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>, <span class="dv">4</span>))</span>
<span id="cb41-192"><a href="#cb41-192" aria-hidden="true" tabindex="-1"></a>plt.plot(targets[:<span class="dv">100</span>], label<span class="op">=</span><span class="st">&#39;Actual&#39;</span>)</span>
<span id="cb41-193"><a href="#cb41-193" aria-hidden="true" tabindex="-1"></a>plt.plot(preds[:<span class="dv">100</span>], label<span class="op">=</span><span class="st">&#39;Predicted Prob&#39;</span>)</span>
<span id="cb41-194"><a href="#cb41-194" aria-hidden="true" tabindex="-1"></a>plt.legend()</span>
<span id="cb41-195"><a href="#cb41-195" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">&quot;Prediction Probability vs Actual Movement&quot;</span>)</span>
<span id="cb41-196"><a href="#cb41-196" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code></pre></div>
<div class="output display_data">
<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Ticker</th>
      <th>Date</th>
      <th>Close</th>
      <th>Volume</th>
      <th>CompoundedReturn</th>
      <th>RSI_14</th>
      <th>HMA_10</th>
      <th>EMA_10</th>
      <th>EMA_30</th>
      <th>FallingHull</th>
      <th>Phase</th>
      <th>FutureReturn</th>
      <th>BuySignal</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>31575</th>
      <td>ADBE</td>
      <td>2014-11-13</td>
      <td>0.022921</td>
      <td>14.755831</td>
      <td>0.192223</td>
      <td>67.071786</td>
      <td>0.023165</td>
      <td>0.021140</td>
      <td>0.014252</td>
      <td>1</td>
      <td>4</td>
      <td>-0.182657</td>
      <td>0</td>
    </tr>
    <tr>
      <th>31576</th>
      <td>ADBE</td>
      <td>2014-11-14</td>
      <td>0.022287</td>
      <td>14.719932</td>
      <td>0.321360</td>
      <td>64.709757</td>
      <td>0.022783</td>
      <td>0.021349</td>
      <td>0.014770</td>
      <td>1</td>
      <td>4</td>
      <td>0.436433</td>
      <td>1</td>
    </tr>
    <tr>
      <th>31577</th>
      <td>ADBE</td>
      <td>2014-11-17</td>
      <td>0.019221</td>
      <td>15.051883</td>
      <td>-0.324327</td>
      <td>54.685563</td>
      <td>0.021756</td>
      <td>0.020962</td>
      <td>0.015058</td>
      <td>1</td>
      <td>5</td>
      <td>0.337734</td>
      <td>1</td>
    </tr>
    <tr>
      <th>31578</th>
      <td>ADBE</td>
      <td>2014-11-18</td>
      <td>0.021039</td>
      <td>14.856918</td>
      <td>0.063085</td>
      <td>58.765518</td>
      <td>0.020939</td>
      <td>0.020976</td>
      <td>0.015444</td>
      <td>1</td>
      <td>4</td>
      <td>0.149749</td>
      <td>1</td>
    </tr>
    <tr>
      <th>31579</th>
      <td>ADBE</td>
      <td>2014-11-19</td>
      <td>0.021018</td>
      <td>14.601146</td>
      <td>0.321360</td>
      <td>58.699336</td>
      <td>0.020461</td>
      <td>0.020984</td>
      <td>0.015803</td>
      <td>1</td>
      <td>4</td>
      <td>0.319920</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>
</div>
<div class="output stream stdout">
<pre><code>Epoch 1/100, Loss: 0.1737
Epoch 2/100, Loss: 0.1738
Epoch 3/100, Loss: 0.1719
Epoch 4/100, Loss: 0.1717
Epoch 5/100, Loss: 0.1725
Epoch 6/100, Loss: 0.1706
Epoch 7/100, Loss: 0.1683
Epoch 8/100, Loss: 0.1694
Epoch 9/100, Loss: 0.1682
Epoch 10/100, Loss: 0.1682
Epoch 11/100, Loss: 0.1685
Epoch 12/100, Loss: 0.1674
Epoch 13/100, Loss: 0.1667
Epoch 14/100, Loss: 0.1641
Epoch 15/100, Loss: 0.1657
Epoch 16/100, Loss: 0.1651
Epoch 17/100, Loss: 0.1637
Epoch 18/100, Loss: 0.1616
Epoch 19/100, Loss: 0.1608
Epoch 20/100, Loss: 0.1632
Epoch 21/100, Loss: 0.1607
Epoch 22/100, Loss: 0.1610
Epoch 23/100, Loss: 0.1601
Epoch 24/100, Loss: 0.1614
Epoch 25/100, Loss: 0.1575
Epoch 26/100, Loss: 0.1555
Epoch 27/100, Loss: 0.1580
Epoch 28/100, Loss: 0.1585
Epoch 29/100, Loss: 0.1561
Epoch 30/100, Loss: 0.1552
Epoch 31/100, Loss: 0.1525
Epoch 32/100, Loss: 0.1532
Epoch 33/100, Loss: 0.1513
Epoch 34/100, Loss: 0.1485
Epoch 35/100, Loss: 0.1485
Epoch 36/100, Loss: 0.1467
Epoch 37/100, Loss: 0.1481
Epoch 38/100, Loss: 0.1476
Epoch 39/100, Loss: 0.1479
Epoch 40/100, Loss: 0.1477
Epoch 41/100, Loss: 0.1430
Epoch 42/100, Loss: 0.1398
Epoch 43/100, Loss: 0.1404
Epoch 44/100, Loss: 0.1419
Epoch 45/100, Loss: 0.1391
Epoch 46/100, Loss: 0.1398
Epoch 47/100, Loss: 0.1359
Epoch 48/100, Loss: 0.1355
Epoch 49/100, Loss: 0.1367
Epoch 50/100, Loss: 0.1351
Epoch 51/100, Loss: 0.1333
Epoch 52/100, Loss: 0.1323
Epoch 53/100, Loss: 0.1351
Epoch 54/100, Loss: 0.1320
Epoch 55/100, Loss: 0.1326
Epoch 56/100, Loss: 0.1318
Epoch 57/100, Loss: 0.1270
Epoch 58/100, Loss: 0.1316
Epoch 59/100, Loss: 0.1315
Epoch 60/100, Loss: 0.1290
Epoch 61/100, Loss: 0.1278
Epoch 62/100, Loss: 0.1286
Epoch 63/100, Loss: 0.1265
Epoch 64/100, Loss: 0.1254
Epoch 65/100, Loss: 0.1275
Epoch 66/100, Loss: 0.1233
Epoch 67/100, Loss: 0.1227
Epoch 68/100, Loss: 0.1214
Epoch 69/100, Loss: 0.1219
Epoch 70/100, Loss: 0.1246
Epoch 71/100, Loss: 0.1243
Epoch 72/100, Loss: 0.1211
Epoch 73/100, Loss: 0.1202
Epoch 74/100, Loss: 0.1196
Epoch 75/100, Loss: 0.1207
Epoch 76/100, Loss: 0.1240
Epoch 77/100, Loss: 0.1194
Epoch 78/100, Loss: 0.1161
Epoch 79/100, Loss: 0.1173
Epoch 80/100, Loss: 0.1176
Epoch 81/100, Loss: 0.1188
Epoch 82/100, Loss: 0.1173
Epoch 83/100, Loss: 0.1174
Epoch 84/100, Loss: 0.1159
Epoch 85/100, Loss: 0.1148
Epoch 86/100, Loss: 0.1144
Epoch 87/100, Loss: 0.1142
Epoch 88/100, Loss: 0.1124
Epoch 89/100, Loss: 0.1099
Epoch 90/100, Loss: 0.1127
Epoch 91/100, Loss: 0.1110
Epoch 92/100, Loss: 0.1163
Epoch 93/100, Loss: 0.1114
Epoch 94/100, Loss: 0.1100
Epoch 95/100, Loss: 0.1074
Epoch 96/100, Loss: 0.1104
Epoch 97/100, Loss: 0.1101
Epoch 98/100, Loss: 0.1089
Epoch 99/100, Loss: 0.1077
Epoch 100/100, Loss: 0.1104
Accuracy: 0.6040, F1 Score: 0.6754, ROC AUC: 0.5841
</code></pre>
</div>
<div class="output display_data">
<p><img
src="vertopal_3029dff3b32943149bfb6de06d795b6a/3cf106dd1e8110732aa97146b2df8305af5fe001.png" /></p>
</div>
</div>
<section id="lstm-model-analysis" class="cell markdown">
<h2>LSTM Model Analysis</h2>
<p>As mentioned above, we aim to build a deep learning model that
predicts whether a stock’s price will go up or down in the near future
using historical data and technical indicators.</p>
<h3 id="data-preparation">Data Preparation</h3>
<ul>
<li>Columns Used: The dataset includes stock tickers, dates, closing
prices, volume, and various technical indicators (RSI, EMA, HMA,
etc.).</li>
<li>Target Variable: We define a binary target where 1 = price goes up
after <code>forecast_horizon</code> days, and 0 = otherwise.</li>
<li>Manually Added Features: We calculated more features to help capture
short-term trends and patterns that might signal price movements:
<ul>
<li>Log Returns</li>
<li>Momentum</li>
<li>Rolling mean and standard deviation</li>
<li>Volatility ratio</li>
<li>Price above EMA</li>
<li>Volume change</li>
</ul></li>
</ul>
<h3 id="sequential-framing">Sequential Framing</h3>
<p>Sequence Length(<code>SEQ_LEN</code>): Each training sample consists
of 30 consecutive days of features, which we use to predict the price
movement for the next day. This means that for each stock, we create
sequences of 30 days of features and the corresponding target value (1
or 0).</p>
<p>Forecast Horizon: We predict the movement of the stock <code>n</code>
days into the future, which in this case is set to 2 days.</p>
<p>The goal of this design was to captrue temporal dependencies in the
data. The LSTM model will learn to recognize patterns in the sequences
of features and use that information to make predictions about future
price movements.</p>
<h3 id="smoothing-the-target">Smoothing the Target</h3>
<p>Label smoothing is a regularization technique used in classification
tasks. Instead of training the model with hard labels (0 or 1), we use
softened versions like 0.05 and 0.95. This helps prevent the model from
becoming overly confident and improves generalization.</p>
<p>In binary classification, training with perfect 0 or 1 labels can
make the model too certain about its predictions. This becomes a problem
when:</p>
<ul>
<li>Labels are noisy or uncertain (e.g., stock movement is inherently
unpredictable)</li>
<li>The model starts to overfit on the training data</li>
<li>We want better probabilistic calibration (i.e., predicted
probabilities should reflect actual likelihoods)</li>
</ul>
<p>Label smoothing mitigates these issues by injecting a bit of
ambiguity into the targets. In our code, we call:</p>
<div class="sourceCode" id="cb43"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> smooth_targets(y, smoothing<span class="op">=</span><span class="fl">0.1</span>):</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> y <span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> smoothing) <span class="op">+</span> <span class="fl">0.5</span> <span class="op">*</span> smoothing</span></code></pre></div>
<p>This blends the original label y with a neutral midpoint (0.5),
weighted by the smoothing factor.</p>
<p>For example:</p>
<p>If y = 1: → 1 * 0.9 + 0.5 * 0.1 = 0.95</p>
<p>If y = 0: → 0 * 0.9 + 0.5 * 0.1 = 0.05</p>
<p>So, instead of telling the model “this is absolutely class 1”, we're
saying “this is very likely class 1”. Since stock direction is noisy and
full of edge cases where prices barely move or reverse unpredictably. In
such contexts, even a correct label might not reflect high certainty.
Smoothing acknowledges this by softening the targets. This aligns with
our use of probabilistic loss (BCEWithLogitsLoss) and an output that
reflects likelihood of upward movement, rather than a strict
classification.</p>
<h3 id="model-architecture">Model Architecture</h3>
<p>The model is designed to process sequences of stock data (30 time
steps each) and output a probability that the stock will go up after a
forecast horizon of 2 days.</p>
<ol>
<li><strong>LSTM Layer</strong></li>
</ol>
<div class="sourceCode" id="cb44"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.lstm <span class="op">=</span> nn.LSTM(input_dim, hidden_dim, num_layers, batch_first<span class="op">=</span><span class="va">True</span>, bidirectional<span class="op">=</span><span class="va">True</span>, dropout<span class="op">=</span><span class="fl">0.3</span>)</span></code></pre></div>
<p>An LSTM (Long Short-Term Memory) is a type of recurrent neural
network (RNN) specialized in learning from sequential data while
mitigating the vanishing gradient problem. It processes each time step
of the input sequence while keeping track of memory over time, allowing
it to model temporal dependencies and trends in the data. We set the
<code>bidirectional=True</code>because the model has access to both past
and future context within the sequence, which can be important in
recognizing patterns that are symmetric or spread across time. Dropout
helps prevent overfitting by randomly "dropping out" some units during
training. Hidden Dim and num_layers control the capacity and depth of
the LSTM. Here, we use 2 layers and a hidden dimension of 128.</p>
<ol>
<li><strong>Attention Mechanism</strong></li>
</ol>
<div class="sourceCode" id="cb45"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.attn <span class="op">=</span> Attention(hidden_dim <span class="op">*</span> <span class="dv">2</span>)</span></code></pre></div>
<p>After the LSTM processes the sequence, it outputs a hidden state for
each time step. However, not all time steps are equally informative. The
attention mechanism assigns weights to each time step, allowing the
model to focus on the most relevant parts of the sequence. The Attention
module does this by computing a learnable score for each time step,
applying a softmax to get a probability distribution (attention
weights), and computing a weighted sum (the context vector). This is
particularly useful in time series where some historical events matter
more than others (e.g., a sudden spike in volume might be more important
than a flat day).</p>
<ol>
<li><strong>Layer Normalization</strong></li>
</ol>
<div class="sourceCode" id="cb46"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.ln <span class="op">=</span> nn.LayerNorm(hidden_dim <span class="op">*</span> <span class="dv">2</span>)</span></code></pre></div>
<p>After attention, we apply layer normalization to stabilize and
accelerate training. It standardizes the outputs of the attention layer,
helping gradients flow more smoothly and improving convergence. This is
especially useful in deep networks and recurrent layers like LSTM.</p>
<ol>
<li><strong>Fully Connected Layer</strong></li>
</ol>
<div class="sourceCode" id="cb47"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="va">self</span>.fc <span class="op">=</span> nn.Sequential(</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    nn.Linear(hidden_dim <span class="op">*</span> <span class="dv">2</span>, <span class="dv">64</span>),</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    nn.ReLU(),</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    nn.Dropout(<span class="fl">0.2</span>),</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    nn.Linear(<span class="dv">64</span>, <span class="dv">1</span>)</span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>The output from the attention block is passed to a fully connected
feedforward network. The first layer reduces the dimensionality and
applies a non-linearity (ReLU) to help the model learn complex patterns.
The final layer outputs a single logit, which represents the model's
confidence about the stock going up. We don't apply a sigmoid activation
here because we use BCEWithLogitsLoss, which combines the sigmoid and
binary cross-entropy in a numerically stable way.</p>
<p><strong>Focal Loss</strong></p>
<div class="sourceCode" id="cb48"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> FocalLoss(nn.Module):</span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>    ...</span></code></pre></div>
<p>In standard binary classification, we might use Binary Cross Entropy
(BCE). However, stock movements are often imbalanced (e.g., more
flat/down days than big up days), or the model may find some examples
easier to learn than others. To address this, we use Focal Loss, a
modification of BCE that down-weights easy examples and focuses the
learning on harder, misclassified examples. It introduces a tunable
parameter gamma (typically 2.0). When a prediction is correct and
confident, the loss is small; when it’s wrong or uncertain, the loss is
larger. This shifts the model's focus to edge cases or rare patterns
that might otherwise be ignored. This is a good choice for stock
movement prediction because the signal is noisy and imbalanced, we care
more about the uncertain or borderline cases (e.g., sudden shifts,
reversals), and we want the model to be robust under volatile or
ambiguous market conditions.</p>
<h3 id="model-training-and-evaluation">Model Training and
Evaluation</h3>
<p>Once the model is defined, we move on to training and evaluating its
performance. This step involves teaching the model how to make
predictions and then testing how well it learned.</p>
<h4 id="training-loop">Training Loop</h4>
<div class="sourceCode" id="cb49"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>train_model(model, train_loader, optimizer, criterion, scheduler)</span></code></pre></div>
<p>The model is trained using mini-batches of data drawn from the
training set. For each batch:</p>
<ul>
<li>We pass the inputs through the model to get predictions.</li>
<li>Compute the loss between the predictions and the (smoothed) targets
using Focal Loss.</li>
<li>Perform backpropagation and update the model's weights using Adam
optimizer.</li>
<li>We clip gradients using clip_grad_norm_ to prevent exploding
gradients, which can happen in RNNs.</li>
</ul>
<p>A learning rate scheduler gradually reduces the learning rate over
time (every 5 epochs by 10%), helping the model settle into a better
minimum. We also implement early stopping -- if the validation loss
doesn’t improve after 10 epochs, training stops to prevent
overfitting.</p>
<h4 id="evaluation-loop">Evaluation Loop</h4>
<div class="sourceCode" id="cb50"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>preds, targets <span class="op">=</span> evaluate_model(model, test_loader)</span></code></pre></div>
<p>Once training is complete, we evaluate the model on the held-out test
set. We use the model in inference mode (model.eval()), disabling
dropout and stopping gradient computation.</p>
<p>For each batch in the test set:</p>
<ul>
<li>We compute the model’s output probabilities (via sigmoid).</li>
<li>We convert them into binary predictions (1 if probability &gt; 0.5,
else 0).</li>
<li>We compare these predictions to the true labels to compute
metrics.</li>
</ul>
<p>The key evaluation metrics we compute are Accuracy, F1 Score, and ROC
AUC. The accuracy gives us a general idea of how well the model is
performing, since it is calculated as the number of correct predictions
divided by the total number of predictions. The F1 Score is the harmonic
mean of precision and recall, which is useful for imbalanced classes.
The ROC AUC score measures how well the model ranks positive samples
higher than negatives, independent of classification threshold.</p>
<h3 id="visualization">Visualization</h3>
<div class="sourceCode" id="cb51"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>plt.plot(targets[:<span class="dv">100</span>], label<span class="op">=</span><span class="st">&#39;Actual&#39;</span>)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>plt.plot(preds[:<span class="dv">100</span>], label<span class="op">=</span><span class="st">&#39;Predicted Prob&#39;</span>)</span></code></pre></div>
<p>We visualize the model’s predicted probabilities vs. actual labels
over time to inspect how well the model is tracking the signal. This
gives us intuition about whether the model is reacting to meaningful
patterns or just noise.</p>
<h3 id="overall-performance">Overall Performance</h3>
<p>Overall, the model achieved an accuracy of 0.6318, F1 Score of
0.6891, and ROC AUC of 0.6207. These metrics indicate that the model is
able to predict stock price movements with a reasonable level of
accuracy, but there is still room for improvement. The F1 Score is
particularly important in this context, as it balances precision and
recall, which is crucial when dealing with imbalanced classes in stock
price movements. The ROC AUC score also suggests that the model has some
ability to distinguish between positive and negative samples, but it is
not perfect.</p>
</section>
<section id="hypothesis-test-to-show-effeciveness-of-model"
class="cell markdown">
<h3>Hypothesis Test to show effeciveness of Model</h3>
</section>
<div class="cell code">
<div class="sourceCode" id="cb52"><pre
class="sourceCode python"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Statistical Hypothesis Tests ---</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> scipy.stats <span class="im">import</span> binomtest</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a><span class="co"># --- 1. Binomial Test: Is accuracy better than random? ---</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>n_correct <span class="op">=</span> np.<span class="bu">sum</span>(np.array(preds) <span class="op">==</span> np.array(targets))</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>n_total <span class="op">=</span> <span class="bu">len</span>(targets)</span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>accuracy <span class="op">=</span> n_correct <span class="op">/</span> n_total</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Model accuracy: </span><span class="sc">{</span>accuracy<span class="sc">:.4f}</span><span class="ss">&quot;</span>)</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Null: model is correct with probability 0.5 (random guessing)</span></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>p_value_binom <span class="op">=</span> binomtest(n_correct, n_total, p<span class="op">=</span><span class="fl">0.5</span>, alternative<span class="op">=</span><span class="st">&#39;greater&#39;</span>)</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f&quot;Binomial test p-value (accuracy &gt; 0.5): </span><span class="sc">{</span>p_value_binom<span class="sc">.</span>pvalue<span class="sc">:.4g}</span><span class="ss">&quot;</span>)</span></code></pre></div>
<div class="output stream stdout">
<pre><code>Model accuracy: 0.6040
Binomial test p-value (accuracy &gt; 0.5): 0.0006065
</code></pre>
</div>
</div>
<div class="cell markdown">
<p>Since the p-value is less than 0.05 we reject the null hypothesis.
This means that the LSTM model does a better job at predicting whether a
stock price does up or down compared to randomly guessing at a
statistically significant level. So the model provides us an idea
whether the stock price will go up or down.</p>
</div>
<section id="insights-and-conclusions" class="cell markdown">
<h1>Insights and Conclusions</h1>
<h3 id="1-performance-interpretation">1. Performance Interpretation</h3>
<ul>
<li><p><strong>Accuracy (0.63):</strong><br />
The model correctly classifies about 63% of the samples. This is better
than random guessing (which would be 50% for a balanced dataset),
showing that the model is learning some meaningful patterns from the
data.</p></li>
<li><p><strong>F1 Score (0.69):</strong><br />
The F1 score is relatively higher than accuracy. This could indicate
that class imbalance is present (i.e., more of one class than the
other), and the model is handling it reasonably well by balancing
precision and recall.</p></li>
<li><p><strong>ROC AUC (0.62):</strong><br />
The ROC AUC measures the model's ability to distinguish between the two
classes. A value of 0.62 is above chance, but not particularly strong.
It shows the model has some predictive power, but there's still
considerable room for improvement.</p></li>
</ul>
<hr />
<h3 id="2-insights">2. Insights</h3>
<ul>
<li><p><strong>Temporal Dependencies:</strong><br />
The use of LSTM and attention seems to have helped the model capture
temporal patterns in the stock data, as evidenced by performance being
noticeably above random. Attention especially may have helped the model
focus on the most relevant parts of the input sequence.</p></li>
<li><p><strong>Stock Movement Predictability:</strong><br />
Predicting stock prices is notoriously difficult due to their noisy and
partially random nature. Achieving any lift above random (50%) is
meaningful and shows that the model is extracting some signal from the
noise.</p></li>
<li><p><strong>Improvement over Baseline:</strong><br />
If compared to a naive baseline or a simple logistic regression, this
model likely performs better, justifying the use of LSTM and attention
mechanisms for this type of time series data.</p></li>
</ul>
<hr />
<h3 id="3-limitations--considerations">3. Limitations &amp;
Considerations</h3>
<ul>
<li><p><strong>Moderate Predictive Power:</strong><br />
While above chance, the metrics are still modest. This might not be
sufficient for real-world trading, where transaction costs and risk must
be considered.</p></li>
<li><p><strong>Potential Overfitting:</strong><br />
If the model was evaluated on the training set or if there was data
leakage, the true out-of-sample performance could be lower.</p></li>
<li><p><strong>Feature Engineering:</strong><br />
Performance could potentially be improved with better features (e.g.,
adding technical indicators, macroeconomic data, or sentiment
features).</p></li>
<li><p><strong>Market Efficiency:</strong><br />
The modest performance aligns with the Efficient Market Hypothesis,
which posits that it is difficult to consistently outperform the market
using historical price data alone.</p></li>
</ul>
<hr />
<h3 id="4-conclusions--next-steps">4. Conclusions &amp; Next Steps</h3>
<ul>
<li>The LSTM with attention is able to extract some predictive signal
from historical stock price data, as shown by performance above
random.</li>
<li>However, the predictive power is moderate, which is typical for
financial time series prediction.</li>
<li>Further improvements may be possible by:
<ul>
<li>Enhancing feature engineering</li>
<li>Tuning the model architecture and hyperparameters</li>
<li>Incorporating alternative data sources (news, sentiment, etc.)</li>
<li>Ensuring robust cross-validation and out-of-sample testing</li>
</ul></li>
</ul>
</section>
</body>
</html>
